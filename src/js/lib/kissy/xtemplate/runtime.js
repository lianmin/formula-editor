/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Aug 13 18:33
*/
KISSY.add("xtemplate/runtime",["util","logger-manager","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(p,g,n,l){function j(a,h,b){var b=a.fn(h,b),c=a.runtime.extendTplName;c&&(delete a.runtime.extendTplName,b=a.root.include(c,a,h,null,b));return b.end()}function i(a,h,c,f,e,d,j,i){var k;if(!d){k=a.runtime.commands;var g=a.root.config.commands,m=e[0];k=k&&k[m]||g&&g[m]||b[m];if(1!==e.length&&k){g=e.length;for(m=1;m<g&&!(k=k[e[m]],!k);m++);}}if(k)return k.call(a,h,c,f,j);
e.join(".");return i&&(a=h.resolve(e.slice(0,-1),d),e=a[e[e.length-1]])?e.apply(a,c.params):f}function d(a,b){this.fn=a;b=this.config=b||{};b.loader=b.loader||e;this.subNameResolveCache={}}p=g("util");g("logger-manager");var n=g("./runtime/commands"),b={},a=g("./runtime/scope"),f=g("./runtime/linked-buffer"),c={callFn:function(a,b,c,f,e,d,j){return i(a,b,c,f,e,d,j,!0)},callCommand:function(a,b,c,f,e,d){return i(a,b,c,f,e,0,d,!0)}},e={cache:{},load:function(a,b){var c=a.name,f=this.cache;if(f[c])return b(void 0,
f[c]);g([c],{success:function(a){f[c]=a;b(void 0,a)},error:function(){b('template "'+a.name+'" does not exist')}})}};p.mix(d,{loader:e,nativeCommands:n,utils:c,addCommand:function(a,c){b[a]=c},removeCommand:function(a){delete b[a]}});d.prototype={constructor:d,Scope:a,nativeCommands:n,utils:c,removeCommand:function(a){var b=this.config;b.commands&&delete b.commands[a]},addCommand:function(a,b){var c=this.config;c.commands=c.commands||{};c.commands[a]=b},resolve:function(a,b){if("."!==a.charAt(0))return a;
var c=this.subNameResolveCache[b]=this.subNameResolveCache[b]||{};if(c[a])return c[a];var f=a,e,d=a;e=b.split("/");d=d.split("/");e.pop();for(var j=0,i=d.length;j<i;j++){var k=d[j];"."!==k&&(".."===k?e.pop():e.push(k))}e=e.join("/");return a=c[f]=e},include:function(a,b,c,f,e){var d=this,i=b.name,g=d.resolve(a,i);return e.async(function(e){d.config.loader.load({root:d,parentName:i,originalName:a,name:g,scope:c,option:f},function(a,d){a?e.error(a):"string"===typeof d?e.write(d,f&&f.escape).end():j({root:b.root,
fn:d,name:g,runtime:b.runtime},c,e)})})},render:function(b,c,e){var f="",i=this.fn;"function"===typeof c&&(e=c,c=null);var c=c||{},e=e||function(a,b){if(a){a instanceof Error||(a=Error(a));throw a;}f=b},g=this.config.name;!g&&i.TPL_NAME&&(g=i.TPL_NAME);b=new a(b);e=(new d.LinkedBuffer(e,this.config)).head;j({name:g,fn:i,runtime:{commands:c.commands},root:this},b,e);return f}};d.Scope=a;d.LinkedBuffer=f;l.exports=d});
KISSY.add("xtemplate/runtime/commands",["./scope","util"],function(p,g,n,l){var j=g("./scope"),i=g("util"),d={range:function(b,a){var f=a.params,c=f[0],e=f[1];if(f=f[2]){if(c>e&&0<f||c<e&&0>f)f=-f}else f=c>e?-1:1;for(var d=[],h=c;c<e?h<e:h>e;h+=f)d.push(h);return d},each:function(b,a,f){var c=a.params,e=c[0],d=c[2]||"xindex",c=c[1],h,g,o;if(e)if(i.isArray(e)){h=e.length;for(var l=0;l<h;l++)g=new j(e[l]),o=g.affix={xcount:h},o[d]=l,c&&(o[c]=e[l]),g.setParent(b),f=a.fn(g,f)}else for(h in e)g=new j(e[h]),
o=g.affix={},o[d]=h,c&&(o[c]=e[h]),g.setParent(b),f=a.fn(g,f);return f},"with":function(b,a,f){var c=a.params[0];c&&(c=new j(c),c.setParent(b),f=a.fn(c,f));return f},"if":function(b,a,f){if(a.params[0]){var c=a.fn;c&&(f=c(b,f))}else{var c=!1,e=a.elseIfs,a=a.inverse;if(e)for(var d=0,h=e.length;d<h;d++){var g=e[d];if(c=g.test(b)){f=g.fn(b,f);break}}!c&&a&&(f=a(b,f))}return f},set:function(b,a,f){b.mix(a.hash);return f},include:function(b,a,f){var c=a.params,e,d=c.length;e=b;a.hash&&(e=new j(a.hash),
e.setParent(b));for(b=0;b<d;b++)f=this.root.include(c[b],this,e,a,f);return f},parse:function(b,a,f){return d.include.call(this,new j,a,f)},extend:function(b,a,f){this.runtime.extendTplName=a.params[0];return f},block:function(b,a,f){var c=this.runtime,e=a.params,d=e[0],h;2===e.length&&(h=e[0],d=e[1]);var e=c.blocks=c.blocks||{},g=e[d],a={fn:a.fn,type:h};if(g){if(g.type)if("append"===g.type)a.next=g,e[d]=a;else if("prepend"===g.type){var i;for(h=g;h&&"prepend"===h.type;)i=h,h=h.next;a.next=h;i.next=
a}}else e[d]=a;if(!c.extendTplName)for(h=e[d];h;)h.fn&&(f=h.fn.call(this,b,f)),h=h.next;return f},macro:function(b,a,f,c){var b=a.hash,e=a.params,d=e[0],e=e.slice(1),h=this.runtime,h=h.macros=h.macros||{};if(a.fn)h[d]={paramNames:e,hash:b,fn:a.fn};else{var a=h[d],d=a.hash||{},g;if(a&&(g=a.paramNames)){c=0;for(h=g.length;c<h;c++)d[g[c]]=e[c];if(b)for(var i in b)d[i]=b[i];g=new j(d);f=a.fn.call(this,g,f)}else throw Error("in file: "+this.name+" can not find macro: "+name+'" at line '+c);}return f}};
l.exports=d});
KISSY.add("xtemplate/runtime/scope",[],function(p,g,n,l){function j(d){this.data=arguments.length?d:{};this.affix=i;this.root=this}var i;j.prototype={isScope:1,setParent:function(d){this.parent=d;this.root=d.root},set:function(d,b){this.affix||(this.affix={});this.affix[d]=b},setData:function(d){this.data=d},getData:function(){return this.data},mix:function(d){var b=this.affix;b||(b=this.affix={});for(var a in d)b[a]=d[a]},get:function(d){var b=this.data,a;a=(a=this.affix)&&a[d];if(a!==i)return a;
b!==i&&null!==b&&(a=b[d]);return a!==i?a:"this"===d?b:"root"===d?this.root.data:a},resolve:function(d,b){var a;if(!b&&1===d.length){a=this.get(d[0]);if(a!==i)return a;b=1}var f=d.length,c=this;if(f&&"root"===d[0])d.shift(),c=c.root,f--;else if(b)for(;c&&b--;)c=c.parent;if(!c)return i;if(!f)return c.data;var e=d[0];do a=c.get(e);while(a===i&&(c=c.parent));if(a&&c){for(c=1;a&&c<f;c++)a=a[d[c]];return a}return i}};l.exports=j});
KISSY.add("xtemplate/runtime/linked-buffer",["util"],function(p,g,n,l){function j(b){this.list=b;this.init()}function i(b,a){this.config=a;this.head=new j(this);this.callback=b;this.init()}var d=g("util");j.prototype={constructor:j,isBuffer:1,init:function(){this.data=""},append:function(b){this.data+=b},write:function(b,a){if(b||0===b)this.append(a?d.escapeHtml(b):b);return this},async:function(b){var a=this.list,d=new j(a),a=new j(a);a.next=this.next;d.next=a;this.next=d;this.ready=!0;b(d);return a},
error:function(b){var a=this.list.callback;a&&(a(b,void 0),this.list.callback=null)},end:function(b,a){this.list.callback&&(this.write(b,a),this.ready=!0,this.list.flush());return this}};i.prototype={constructor:i,init:function(){this.data=""},append:function(b){this.data+=b},end:function(){this.callback(null,this.data)},flush:function(){for(var b=this.head;b;){if(b.ready)this.append(b.data);else return;this.head=b=b.next}this.end()}};i.Buffer=j;l.exports=i});
