/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jul 18 14:04
*/
KISSY.add("router","util,logger-manager,./router/utils,./router/route,url,./router/request,event/dom,event/custom,feature".split(","),function(u,f,c){function p(g,a){var e=j.addVid("#!"+g+(B?"":a?v.REPLACE_HISTORY:""),q);a?location.replace(e):location.hash=e}function i(g){var g=g||location.href,a=r.parse(g);return!n.useHash&&o?a.pathname.substr(n.urlRoot.length)+(a.search||""):j.getHash(g)}function k(g,a,e){function b(){d++;if(d===c)e(g,a);else{var h=m[d];if(x.startsWith(g.path+"/",h[0]+"/")){var f=
h[0].length;g.url=g.url.slice(f);var j=g.path;g.path=g.path.slice(f);h[1](g,b);g.url=g.originalUrl;g.path=j}else b()}}var d=-1,c=m.length;b()}function l(g,a){function e(){b++;if(b!==d){var c=h[b];if(g.params=c.match(g.path)){var f=-1,j=c.callbacks,k=j.length,i=function(b){if(b==="route"){i=null;e()}else{f++;if(f!==k){g.route=c;j[f](g,a,i)}}};i("")}else e()}}var b=-1,d=h.length;e()}function b(g,a){var e=i(),b=r.parse(e,true),d=b.query;b.search="";b.query={};b=r.stringify(b)||"/";e=new C({query:d,backward:g===
true,replace:a===true,forward:g===false&&a===false,path:b,url:e,originalUrl:e});d={redirect:c.navigate};c.fire("dispatch",{request:e,response:d});k(e,d,l)}function a(a){var d=false,e=false;if(a===s[s.length-2]){d=true;s.pop()}else a!==s[s.length-1]?s.push(a):e=true;b(d,e)}function d(g){(g=g.originalEvent.state)&&a(g.vid)}function z(g){(g=A(g.newURL||location.href))&&a(g)}var x=f("util");f("logger-manager");var m=[],h=[],j=f("./router/utils"),D=f("./router/route"),r=f("url"),C=f("./router/request"),
v=f("event/dom"),u=f("event/custom"),A=j.getVidFromUrlWithHash,w=window,t=w.history,B=f("feature").isHashChangeSupported(),o=!(!t||!t.pushState),q=10,s=[q],n={urlRoot:"",useHash:!o};x.mix(c,u.Target);c.use=function(a,b){if(typeof a!=="string"){b=a;a=""}m.push([a,b])};c.navigate=function(a,d){var d=d||{},e=d.replace||false,c=i(),h=r.parse(c);if(a.charAt(0)==="?"){h.search=a;a=r.stringify(h)}if(c!==a){if(!e){q++;s.push(q)}if(!n.useHash&&o){t[e?"replaceState":"pushState"]({vid:q},"",j.getFullPath(a,
n.urlRoot));b(false,e)}else if(o){t[e?"replaceState":"pushState"]({vid:q},"","#!"+a);b(false,e)}else p(a,e)}else d&&d.triggerRoute&&b(false,true)};c.get=function(a){var b=x.makeArray(arguments).slice(1);h.push(new D(a,b,n))};c.matchRoute=function(a){for(var b=0,d=h.length;b<d;b++)if(h[b].match(a))return h[b];return false};c.removeRoute=function(a,b){for(var d=h.length-1;d>=0;d--){var c=h[d];if(c.path===a)if(b){c.removeCallback(b);c.callbacks.length||h.splice(d,1)}else h.splice(d,1)}};c.clearRoutes=
function(){m=[];h=[]};c.hasRoute=function(a){for(var b=0,d=h.length;b<d;b++)if(h[b].path===a)return h[b];return false};c.config=function(a){if(a.urlRoot)a.urlRoot=a.urlRoot.replace(/\/$/,"");x.mix(n,a)};var y;c.start=function(a){if(y)return a&&a.call(c);var h=n.useHash,e=n.urlRoot,f=n.triggerRoute,k=location.pathname,m=location.href,l=i(),r=location.hash.match(/#!.+/);if(!h)if(o){if(r)if(e){if(j.equalsIgnoreSlash(k,e)){t.replaceState({},"",m=j.getFullPath(l,e));f=1}}else{e=location.hash.substring(2);
e[0]==="/"&&(e=e.substring(1));t.replaceState({},"",m=location.protocol+"//"+location.host+location.pathname+e);f=1}}else if(j.equalsIgnoreSlash(k,e))h=true;else{location.replace(j.addEndSlash(e)+"#!"+l);return}setTimeout(function(){var e=o;if(o)v.on(w,"popstate",d);else{v.on(w,"hashchange",z);f=1}if(h)if(i())if(!o&&A(m)!==q){p(j.getHash(m),true);f=0}else o&&j.hasVid(m)&&location.replace(m=j.removeVid(m));else{c.navigate("/",{replace:true});f=0;e=false}e&&t.replaceState({vid:q},"",m);f&&b(false,true);
a&&a(c)},100);y=true;return c};c.Utils=j;c.stop=function(){y=false;v.detach(w,"hashchange",z);v.detach(w,"popstate",d)}});
KISSY.add("router/utils",["event/dom"],function(u,f,c,p){function i(a){return a.replace(/__ks-vid=.+$/,"")}function k(a){var b;return(b=a.match(/__ks-vid=(.+)$/))?parseInt(b[1],10):0}function l(a){return(a=a.match(/#(.+)$/))&&a[1]||""}var b=f("event/dom");p.exports={endWithSlash:function(a){return"/"===a.charAt(a.length-1)},startWithSlash:function(a){return"/"===a.charAt(0)},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&
(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,b){return location.protocol+"//"+location.host+this.removeEndSlash(b)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,b){a=this.removeEndSlash(a);b=this.removeEndSlash(b);return a===b},getHash:function(a){return i(l(a).replace(/^!/,"")).replace(b.REPLACE_HISTORY,"")},removeVid:i,hasVid:function(a){return-1!==a.indexOf("__ks-vid=")},
addVid:function(a,b){return a+"__ks-vid="+b},getVidFromUrlWithHash:function(a){return k(l(a))},getVidFromHash:k}});
KISSY.add("router/route",["util"],function(u,f,c,p){function i(b,a,d,c){l.isArray(b)&&(b="("+b.join("|")+")");b=b.concat(d?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(b,d,c,f,k,i,l){a.push(f);d=d||"";return""+(i?"":d)+"(?:"+(i?d:"")+(c||"")+(k||c&&"([^/.]+?)"||"([^/]+?)")+")"+(i||"")+(l?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return{keys:a,regexp:RegExp("^"+b+"$",c?"":"i")}}function k(b,a,d){this.path=b;this.callbacks=a;this.keys=
[];"string"===typeof b||l.isArray(b)?l.mix(this,i(b,this.keys,d.strict,d.caseSensitive)):this.regexp=b}var l=f("util");k.prototype={match:function(b){b=b.match(this.regexp);if(!b)return!1;for(var a=this.keys,d=[],c=1,f=b.length;c<f;++c){var k=a[c-1],h="string"===typeof b[c]?l.urlDecode(b[c]):b[c];k?d[k]=h:d.push(h)}return d},removeCallback:function(b){for(var a=this.callbacks||[],d=a.length-1;0<=d;d++)a===b&&a.splice(d,1)}};p.exports=k});
KISSY.add("router/request",[],function(u,f,c,p){function i(c){for(var f in c)this[f]=c[f]}i.prototype={param:function(c){return c in this.params?this.params[c]:this.query[c]}};p.exports=i});
