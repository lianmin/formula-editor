/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Aug 8 13:44
*/
KISSY.add("editor","util,logger-manager,node,xtemplate/runtime,editor/iframe-content-xtpl,editor/base,editor/utils,editor/focus-manager,editor/clipboard,editor/enter-key,editor/html-data-processor,editor/selection-fix,editor/styles,editor/dom-iterator,editor/z-index-manager,ua".split(","),function(z,b,C,x){function s(v,a){var m=v.get("textarea"),c=v.get("toolBarEl"),d=v.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));m.parent().css(A,a);m.css(A,a)}function r(v,
a){var m=v.body;J(function(){v.designMode="on";setTimeout(function P(){v.designMode="off";m.focus();if(!P.retry)P.retry=p},50)},function(){v.designMode="off";m.setAttribute("contentEditable",false);m.setAttribute("contentEditable",true);a||r(v,1)})}function o(v){var a=v.get("textarea")[0],m=v.get("window"),d=v.get("document"),e=d[0];if(n.webkit){d.on("click",function(v){var a=i(v.target);w.inArray(a.nodeName(),["input","select"])&&v.preventDefault()});d.on("mouseup",function(v){var a=i(v.target);
w.inArray(a.nodeName(),["input","textarea"])&&v.preventDefault()})}if(n.gecko||n.ie){var p;p=i('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>').insertAfter(a);p.on("focus",function(){v.focus()});v.activateGecko=function(){n.gecko&&v.__iframeFocus&&p[0].focus()};v.on("destroy",function(){p.detach();p.remove()})}m.on("focus",function(){n.gecko&&r(e,j);v.notifySelectionChange()});if(n.gecko)d.on("mousedown",function(){v.__iframeFocus||r(e,j)});if(H){d.on("keydown",
function(a){if(a.keyCode in{8:1,46:1}){var m=v.getSelection(),d=m.getSelectedElement();if(d){v.execCommand("save");var c=m.getRanges()[0].createBookmark();d.remove();m.selectBookmarks([c]);v.execCommand("save");a.preventDefault()}}});if(e.compatMode==="CSS1Compat"){var g={33:1,34:1};d.on("keydown",function(a){a.keyCode in g&&setTimeout(function(){v.getSelection().scrollIntoView()},0)})}}if(n.webkit)d.on("mousedown",function(a){a=i(a.target);w.inArray(a.nodeName(),["img","hr","input","textarea","select"])&&
v.getSelection().selectElement(a)});if(n.gecko)d.on("dragstart",function(v){var a=i(v.target);a.nodeName()==="img"&&/ke_/.test(a[0].className)&&v.preventDefault()});c.add(v)}function u(v,a,m,d){var c="",e;e=b.resolve("editor/assets/iframe.css");m=m.concat([]);m.unshift(e);for(e=0;e<m.length;e++)c=c+w.substitute('<link href="{href}" rel="stylesheet" />',{href:m[e]});return(new y(t)).render({doctype:n.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:c,style:"<style>"+
a+"</style>",data:d||"",script:v?'<script id="ke_active_script">'+(i(window).isCustomDomain()?'document.domain="'+document.domain+'";':"")+"parent.KISSY.require('editor')._initIframe(\""+v+'");<\/script>':""})}function h(v,a){function m(){g=p.document;v.setInternal("document",i(g));v.setInternal("window",i(p));d.detach();g.open("text/html","replace");g.write(c);g.close()}var d=v.get("iframe"),c=u(v.get("id"),v.get("customStyle"),v.get("customLink"),a),e=d[0],p=e.contentWindow,g;d.__loaded=1;try{g=
p.document}catch(j){e.src=e.src;if(H<7){setTimeout(m,10);return}}m()}function l(v,a){var m=i(window).getEmptyIframeSrc()||"";m&&(m=' src="'+m+'" ');var m=i(w.substitute(F,{iframeSrc:m,prefixCls:v.get("prefixCls")})),d=v.get("textarea");d.hasAttr("tabindex")&&m.attr("tabindex",n.webkit?-1:d.attr("tabindex"));d.parent().prepend(m);v.set("iframe",m);v.__docReady=0;if(n.gecko&&!m.__loaded)m.on("load",function(){h(v,a)},v);else h(v,a)}function k(v){if(v.get("iframe")){var a=v.get("iframe"),m=v.get("window"),
v=v.get("document"),d=v[0],c=i(d.documentElement),d=i(d.body);w.each([v,c,d,m],function(v){v.detach()});a.remove()}}var w=b("util");b("logger-manager");var i=b("node"),y=b("xtemplate/runtime"),t=b("editor/iframe-content-xtpl"),q=b("editor/base"),g=b("editor/utils"),c=b("editor/focus-manager"),f=b("editor/clipboard"),e=b("editor/enter-key"),a=b("editor/html-data-processor"),d=b("editor/selection-fix");b("editor/styles");b("editor/dom-iterator");b("editor/z-index-manager");x.exports=q;var p=true,j=
false,n=b("ua"),H=n.ieMode<11,I=i.Dom.NodeType,A="height",J=g.tryThese,F='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',m=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;q.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};var D=w.buffer(function(){this.execCommand("save")},50);q.addMembers({initializer:function(){this.__commands={};this.__controls={};c.register(this)},renderUI:function(){f.init(this);e.init(this);a.init(this);
d.init(this)},bindUI:function(){function v(){a.detach("docReady",v);if(a.get("focused"))a.focus();else{var m=a.getSelection();m&&m.removeAllRanges()}}var a=this,m,d=a.get("prefixCls"),c=a.get("textarea");if(a.get("attachForm")&&(m=c[0].form)&&(m=i(m)))m.on("submit",a.sync,a);a.on("docReady",v);a.on("blur",function(){a.$el.removeClass(d+"editor-focused")});a.on("focus",function(){a.$el.addClass(d+"editor-focused")})},syncUI:function(){s(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},
getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,m){this.__controls[a]=m},showDialog:function(a,m){var a=a+"/dialog",d=this.__controls[a];d.show(m);this.fire("dialogShow",{dialog:d.dialog,pluginDialog:d,dialogName:a})},addCommand:function(a,m){this.__commands[a]=m},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var m=this.__commands[a],d=w.makeArray(arguments);d.shift();d.unshift(this);if(m)return m.exec.apply(m,
d)},queryCommandValue:function(a){return this.execCommand(g.getQueryCmd(a))},setData:function(a){var m,d=a;if(this.get("mode")!==1)this.get("textarea").val(a);else{if(m=this.htmlDataProcessor)d=m.toDataFormat(a);k(this);l(this,d)}},getData:function(a,d){var c=this.htmlDataProcessor,e;d===void 0&&(d=this.get("mode"));e=d===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());e=a?c.toHtml(e):c.toServer(e);e=w.trim(e);m.test(e)&&(e="");return e},getFormatData:function(a){return this.getData(1,
a)},getDocHtml:function(){return u(0,this.get("customStyle"),this.get("customLink"),this.getFormatData())},getSelection:function(){return q.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],m="";if(a){a=a.cloneContents();m=this.get("document")[0].createElement("div");m.appendChild(a);m=m.innerHTML}return m},focus:function(){var a=this.get("window");if(a){var m=this.get("document")[0],a=a[0];n.ie||a&&a.parent&&a.parent.focus();a&&a.focus();
try{m.body.focus()}catch(d){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,m){var d=this.get("window"),c=this.get("customStyle")||"";this.set("customStyle",c+("\n"+a));d&&d.addStyleSheet(a,m)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var m=this.get("customLink"),d=this.get("document")[0];m.push(a);this.set("customLink",m);m=d.createElement("link");m.rel=
"stylesheet";d.getElementsByTagName("head")[0].appendChild(m);m.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(m){m.attr("href")===a&&m.remove()});var m=this.get("customLink"),d=w.indexOf(a,m);d!==-1&&m.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=
setTimeout(function(){var m=a.getSelection();if(m&&!m.isInvalid){var d=m.getStartElement(),c=new q.ElementPath(d);if(!a.__previousPath||!a.__previousPath.compare(c)){a.__previousPath=c;a.fire("selectionChange",{selection:m,path:c,element:d})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===1){this.focus();var m,d=a.nodeName(),c=q.XHTML_DTD,e=c.$block[d],g=q.RangeType,j=(d=this.getSelection())&&d.getRanges(),
n,i,f;if(j&&j.length!==0){this.execCommand("save");for(i=j.length-1;i>=0;i--){n=j[i];m=!i&&a||a.clone(p);n.insertNodeByDtd(m);f||(f=m)}if(f){n.moveToPosition(f,g.POSITION_AFTER_END);if(e){a=q.Walker.whitespaces(true);(a=(f=f.next(a,1))&&f[0].nodeType===I.ELEMENT_NODE&&f.nodeName())&&c.$block[a]&&c[a]["#text"]&&n.moveToElementEditablePosition(f)}d.selectRanges([n]);this.focus();m&&m[0].nodeType===1&&m.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});D.call(this);
return m}}}},insertHtml:function(a,m){var d=this,c,e=d.get("document")[0];if(d.get("mode")===1){if(c=d.htmlDataProcessor)a=c.toDataFormat(a,m);d.focus();d.execCommand("save");if(c=e.selection){c.type==="Control"&&c.clear();try{c.createRange().pasteHTML(a)}catch(p){}}else{c=d.get("iframe")[0].contentWindow.getSelection();var g=c.getRangeAt(0);g.deleteContents();var j=e.createElement("div");j.innerHTML=a;for(var e=e.createDocumentFragment(),n,i;n=j.firstChild;)i=e.appendChild(n);g.insertNode(e);if(i){g=
g.cloneRange();g.setStartAfter(i);g.collapse(true);c.removeAllRanges();c.addRange(g)}}setTimeout(function(){d.getSelection().scrollIntoView()},50);D.call(d)}},_onSetHeight:function(a){s(this,a)},_onSetMode:function(a){var m=this.get("iframe"),d=this.get("textarea");if(a===1){this.setData(d.val());d.hide();this.fire("wysiwygMode")}else{if(m){d.val(this.getFormatData(1));m.hide()}d.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,
m=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(a=m[0].form)&&(a=i(a))&&a.detach("submit",this.sync,this);if(d){a=i(d[0].body);var m=i(d[0].documentElement),e=this.get("window");c.remove(this);d.detach();m.detach();a.detach();e.detach()}w.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});q.decorate=function(a,m){var m=m||{},a=i(a),d=m.textareaAttrs=m.textareaAttrs||{},c=a.style("width"),e=a.style("height"),p=a.attr("name");if(c)m.width=
m.width||c;if(e)m.height=m.height||e;if(p)d.name=p;m.data=m.data||a.val();m.elBefore=a;d=(new q(m)).render();a.remove();return d};q._initIframe=function(a){var m=c.getInstance(a),a=m.get("document"),d=a[0];a.one("#ke_active_script").remove();o(m);var e=d.body,g=i(e);if(H){e.hideFocus=p;e.disabled=p;e.contentEditable=p;e.removeAttribute("disabled")}else setTimeout(function(){n.gecko?e.contentEditable=p:n.webkit?e.parentNode.contentEditable=p:d.designMode="on"},0);if(n.gecko){var D=d.documentElement;
i(D).on("mousedown",function(a){if(a.target===D){n.gecko&&r(d,j);m.activateGecko()}})}setTimeout(function(){H&&setTimeout(function(){if(d){e.runtimeStyle.marginBottom="0px";e.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){m.__docReady=1;m.fire("docReady");var a=m.get("disableObjectResizing"),c=m.get("disableInlineTableEditing");if(a||c)try{d.execCommand("enableObjectResizing",j,!a);d.execCommand("enableInlineTableEditing",j,!c)}catch(e){g.on(H?"resizestart":"resize",function(m){var d=
i(m.target);(a||d.nodeName()==="table"&&c)&&m.preventDefault()})}},10)}});
KISSY.add("editor/iframe-content-xtpl",[],function(z,b,C,x){x.exports=function(b,r){r.write("<!doctype html>\r\n<html>\r\n<head>",0);var o=b.resolve(["doctype"],0);r.write(o,!1);r.write("\r\n    <title>",0);o=b.resolve(["title"],0);r.write(o,!1);r.write("</title>\r\n    ",0);o=b.resolve(["style"],0);r.write(o,!1);r.write("\r\n    ",0);o=b.resolve(["links"],0);r.write(o,!1);r.write('\r\n    </head> \r\n<body class="ks-editor">\r\n',0);o=b.resolve(["data"],0);r.write(o,!1);r.write("\r\n",0);o=b.resolve(["script"],
0);r.write(o,!1);r.write("\r\n</body> \r\n</html>",0);return r};x.exports.TPL_NAME=x.name});
KISSY.add("editor/base",["util","ua","html-parser","component/control","./render-xtpl"],function(z,b,C,x){var s=b("util"),r=b("ua"),z=b("html-parser"),C=b("component/control"),b=b("./render-xtpl");x.exports=C.extend({beforeCreateDom:function(b){s.mix(b,{mobile:r.mobile})}},{Config:{},XHTML_DTD:z.DTD,ATTRS:{handleGestureEvents:{value:!1},focusable:{value:!1},allowTextSelection:{value:!0},contentTpl:{value:b},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},
textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+this.getBaseCssClass("tools")}},statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/render-xtpl",[],function(z,b,C,x){x.exports=function(b,r){var o=this.root.nativeCommands,u=o.each,o=o["if"];r.write('<div class="',0);var h=b.resolve(["prefixCls"],0);r.write(h,!0);r.write('editor-tools">\n\n</div>\n\n<\!--\n//johanbrook.com/browsers/native-momentum-scrolling-ios-5/\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\n--\>\n\n<div class="',0);h=b.resolve(["prefixCls"],0);r.write(h,!0);r.write('editor-textarea-wrap"\n\n',0);var h={escape:1},l=[],k=b.resolve(["mobile"],0);l.push(k);h.params=l;h.fn=
function(k,i){i.write('\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\n',0);return i};r=o.call(this,b,h,r,12);r.write('\n>\n\n<textarea class="',0);h=b.resolve(["prefixCls"],0);r.write(h,!0);r.write('editor-textarea"\n\n',0);h={escape:1};l=[];k=b.resolve(["textareaAttrs"],0);l.push(k);h.params=l;h.fn=function(k,i){i.write("\n",0);var l=k.resolve(["xindex"],0);i.write(l,!0);i.write('="',0);l=k.resolve(["this"],0);i.write(l,!0);i.write('"\n',0);return i};r=u.call(this,b,h,r,19);r.write("\n\n",
0);u={escape:1};h=[];l=b.resolve(["mode"],0);h.push(l);u.params=h;u.fn=function(k,i){i.write('\nstyle="display:none"\n',0);return i};r=o.call(this,b,u,r,23);r.write("\n\n>",0);o=b.resolve(["data"],0);r.write(o,!0);r.write('</textarea>\n\n</div>\n\n<div class="',0);o=b.resolve(["prefixCls"],0);r.write(o,!0);r.write('editor-status">\n\n</div>\n',0);return r};x.exports.TPL_NAME=x.name});
KISSY.add("editor/utils",["util","node","./base","dom","ua"],function(z,b,C,x){var s=b("util"),r=b("node"),z=b("./base"),o=b("dom"),u=b("ua"),h={debugUrl:function(){return""},lazyRun:function(l,k,b){var i=l[k],h=l[b];l[k]=function(){i.apply(this,arguments);l[k]=l[b];return h.apply(this,arguments)}},getXY:function(l,k){var b=l.left,i=l.top,h=k.get("window")[0],b=b-o.scrollLeft(h),i=i-o.scrollTop(h),h=k.get("iframe").offset(),b=b+h.left,i=i+h.top;return{left:b,top:i}},tryThese:function(){for(var l,
k=0,b=arguments.length;k<b;k++){var i=arguments[k];try{l=i();break}catch(h){}}return l},clearAllMarkers:function(l){for(var k in l)l[k]._4eClearMarkers(l,!0,void 0)},ltrim:function(l){return l.replace(/^\s+/,"")},rtrim:function(l){return l.replace(/\s+$/,"")},isNumber:function(l){return/^\d+(.\d+)?$/.test(s.trim(l))},verifyInputs:function(l){for(var k=0;k<l.length;k++){var b=r(l[k]),i=s.trim(h.valInput(b)),o=b.attr("data-verify"),b=b.attr("data-warning");if(o&&!RegExp(o).test(i))return alert(b),!1}return!0},
sourceDisable:function(b,k){b.on("sourceMode",k.disable,k);b.on("wysiwygMode",k.enable,k)},resetInput:function(b){var k=b.attr("placeholder");k&&u.ie?(b.addClass("ks-editor-input-tip"),b.val(k)):u.ie||b.val("")},valInput:function(b,k){if(void 0===k)return b.hasClass("ks-editor-input-tip")?"":b.val();b.removeClass("ks-editor-input-tip");b.val(k)},placeholder:function(b,k){b.attr("placeholder",k);u.ie&&(b.on("blur",function(){s.trim(b.val())||(b.addClass("ks-editor-input-tip"),b.val(k))}),b.on("focus",
function(){b.removeClass("ks-editor-input-tip");s.trim(b.val())===k&&b.val("")}))},normParams:function(b){var b=s.clone(b),k;for(k in b){var h=b[k];"function"===typeof h&&(b[k]=h())}return b},preventFocus:function(b){u.ie?b.unselectable():b.attr("onmousedown","return false;")},injectDom:function(b){s.mix(o,b);for(var k in b)(function(k){r.prototype[k]=function(){var i=[].slice.call(arguments,0);i.unshift(this[0]);return(i=b[k].apply(null,i))&&(i.nodeType||s.isWindow(i))?r(i):s.isArray(i)&&(i.__IS_NODELIST||
i[0]&&i[0].nodeType)?r(i):i}})(k)},addRes:function(){var b=this.__res=this.__res||[];b.push.apply(b,s.makeArray(arguments))},destroyRes:function(){for(var b=this.__res||[],k=0;k<b.length;k++){var h=b[k];"function"===typeof h?h():h.destroy?h.destroy():h.remove&&h.remove()}this.__res=[]},getQueryCmd:function(b){return"query"+("-"+b).replace(/-(\w)/g,function(b,h){return h.toUpperCase()})+"Value"}};z.Utils=h;x.exports=h});
KISSY.add("editor/focus-manager",["./base"],function(z,b,C,x){function s(){var b=this;b.__iframeFocus=l;h=b;u&&clearTimeout(u);u=setTimeout(function(){b.fire("focus")},30)}function r(){var b=this;b.__iframeFocus=k;h=w;u&&clearTimeout(u);u=setTimeout(function(){b.fire("blur")},30)}var z=b("./base"),o={},u,h,l=!0,k=!1,w=null,x=x.exports={currentInstance:function(){return h},getInstance:function(b){return o[b]},register:function(b){o[b.get("id")]=b},add:function(b){this.register(b);b.get("window").on("focus",
s,b).on("blur",r,b)},remove:function(b){delete o[b.get("id")];b.get("window").detach("focus",s,b).detach("blur",r,b)}};z.focusManager=x;z.getInstances=function(){return o}});
KISSY.add("editor/clipboard","util,logger-manager,./base,./range,./selection,node,ua".split(","),function(z,b,C){function x(a,d){var c=a.get("document")[0],e=i(c.body),g=false,b=function(){g=true};e.on(d,b);(y.ieMode>7?c:c.selection.createRange()).execCommand(d);e.detach(d,b);return g}function s(a){this.editor=a;this._init()}function r(a){var d=a.get("document")[0],c=a.getSelection(),e;if(c.getType()===w.SELECTION_ELEMENT&&(e=c.getSelectedElement())){var a=c.getRanges()[0],g=i(d.createTextNode(""));
g.insertBefore(e);a.setStartBefore(g);a.setEndAfter(e);c.selectRanges([a]);setTimeout(function(){if(e.parent()){g.remove();c.selectElement(e)}},0)}}function o(a){if(y.webkit){if(!a.match(/^[^<]*$/g)&&!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(y.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(y.gecko){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function u(a){a=a.replace(/\s+/g,
" ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(y.webkit&&a.indexOf("<div>")>-1){if(a.match(/<div>(?:<br>)?<\/div>/)){a=a.replace(/<div>(?:<br>)?<\/div>/g,function(){return"<p></p>"});a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")}a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"))}else if(y.gecko){y.gecko&&(a=a.replace(/^<br><br>$/,
"<br>"));a.indexOf("<br><br>")>-1&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>")}return a}function h(a){var d=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/gi,"");if(a.indexOf("Apple-")!==-1){a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," ");a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,d){return d.replace(/\t/g,Array(5).join("&nbsp;"))});if(a.indexOf('<br class="Apple-interchange-newline">')>-1){d=1;a=a.replace(/<br class="Apple-interchange-newline">/,
"")}a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1")}!d&&o(a)&&(a=u(a));return a}z=b("util");b("logger-manager");var l=b("./base"),k=b("./range"),w=b("./selection"),i=b("node"),y=b("ua"),t=y.ieMode<11,q=t?"beforepaste":"paste",g=l.RangeType,c=t?function(a,d){return x(a,d)}:function(a,d){try{return a.get("document")[0].execCommand(d)}catch(c){return false}},f={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"};
z.augment(s,{_init:function(){var a=this,d=a.editor,e=d.get("document"),g=e.one("body"),b=function(a){this.type=a};b.prototype={exec:function(d){var e=this.type;d.focus();setTimeout(function(){if(t)if(e==="cut")r(d);else if(e==="paste"){a._preventPasteEvent();a._getClipboardDataFromPasteBin()}c(d,e)||alert(f[e])},0)}};g.on(q,a._getClipboardDataFromPasteBin,a);if(t){g.on("paste",a._iePaste,a);e.on("keydown",a._onKeyDown,a);e.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=
0},0)})}d.addCommand("copy",new b("copy"));d.addCommand("cut",new b("cut"));d.addCommand("paste",new b("paste"))},_onKeyDown:function(a){this.editor.get("mode")===l.Mode.WYSIWYG_MODE&&(a.ctrlKey&&a.keyCode===86||a.shiftKey&&a.keyCode===45)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var d,c=this.editor;if(a==="paste"){this._isPreventBeforePaste=1;try{d=c.get("document")[0].queryCommandEnabled(a)}catch(e){}this._isPreventBeforePaste=0}else d=(a=(a=c.getSelection())&&a.getRanges())&&
!(a.length===1&&a[0].collapsed);return d},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var d=this.editor;if(!this._isPreventPaste){a.preventDefault();d.execCommand("paste")}},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,d=a.get("document")[0];if(!d.getElementById("ke-paste-bin")){var c=a.getSelection(),
e=new k(d),n=i(y.webkit?"<body></body>":"<div></div>",d);n.attr("id","ke-paste-bin");y.webkit&&n[0].appendChild(d.createTextNode("\u200b"));d.body.appendChild(n[0]);n.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});n.css("left","-1000px");var f=c.createBookmarks();e.setStartAt(n,g.POSITION_AFTER_START);e.setEndAt(n,g.POSITION_BEFORE_END);e.select(true);setTimeout(function(){var d,e=n;n=y.webkit&&(d=n.first())&&d.hasClass("Apple-style-span")?
d:n;c.selectBookmarks(f);var g=n.html();e.remove();if(g=h(g)){d=a.fire("paste",{html:g});if(d!==false){d!==void 0&&(g=d);/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?b("editor/plugin/word-filter",function(d){a.insertHtml(d.toDataFormat(g,a))}):a.insertHtml(g)}}},0)}}}});var e={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};C.init=function(a){var d;a.docReady(function(){d=new s(a)});var c={copy:1,cut:1,paste:1},g=["copy","cut","paste"];a.on("contextmenu",function(b){var f=b.contextmenu;if(!f.__copyFix){f.__copyFix=
1;for(b=0;b<g.length;b++)f.addChild({content:e[g[b]],value:g[b]});f.on("click",function(d){var m=d.target.get("value");if(c[m]){f.hide();setTimeout(function(){a.execCommand("save");a.execCommand(m);setTimeout(function(){a.execCommand("save")},10)},30)}})}for(var i=f.get("children"),b=i.length-1;b>=0;b--){var k=i[b],h;h=k.get?k.get("value"):k.value;if(c[h]){h=!d._stateFromNamedCommand(h);k.set?k.set("disabled",h):k.disabled=h}}})}});
KISSY.add("editor/range","./dom,./utils,./walker,./base,./element-path,util,dom,ua,node".split(","),function(z,b,C,x){function s(a){var c=a.nodeType!==e.NodeType.TEXT_NODE&&e.nodeName(a)in d.$removeEmpty,g=a.nodeType===e.NodeType.TEXT_NODE&&!y.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return c||g||a}function r(a){return!H(a)&&!I(a)}function o(m){var d=q;return function(c){if(I(c))return t;if(c.nodeType===e.NodeType.TEXT_NODE){if(y.trim(c.nodeValue).length)return q}else if(c.nodeType===
e.NodeType.ELEMENT_NODE){c=e.nodeName(c);if(!F[c])if(!m&&!a.ie&&c==="br"&&!d)d=t;else return q}return t}}function u(a,d){var c=a.startContainer,g=a.endContainer,b=a.startOffset,f=a.endOffset,n,i=q,k=q,h,l=a.document,R;d>0&&(h=l.createDocumentFragment());if(a.collapsed)return h;a.optimizeBookmark();if(g[0].nodeType===e.NodeType.TEXT_NODE){k=t;g=g._4eSplitText(f)}else if(g[0].childNodes.length>0)if(f>=g[0].childNodes.length){g=p(g[0].appendChild(l.createTextNode("")));R=t}else g=p(g[0].childNodes[f]);
if(c[0].nodeType===e.NodeType.TEXT_NODE){i=t;c._4eSplitText(b)}else if(b)if(b>=c[0].childNodes.length){c=p(c[0].appendChild(l.createTextNode("")));n=t}else c=p(c[0].childNodes[b].previousSibling);else{n=p(l.createTextNode(""));c.prepend(n);c=n;n=t}var o=c._4eParents(),M=g._4eParents();o.each(function(a,d){o[d]=a});M.each(function(a,d){M[d]=a});for(var G,I,l=0;l<o.length;l++){G=o[l];I=M[l];if(!G.equals(I))break}for(var b=h,B,L,H=l;H<o.length;H++){B=o[H];f=d>0&&!B.equals(c)?b.appendChild(B.clone()[0]):
null;B=B[0].nextSibling;L=M[H];for(var A=g[0],r=L&&L[0];B;){if(r===B||A===B)break;L=B.nextSibling;if(d===2)b.appendChild(B.cloneNode(t));else{if(j[B.nodeName.toLowerCase()]){var w=B.cloneNode(t);B.innerHTML="";B=w}else e._4eRemove(B);d===1&&b.appendChild(B)}B=L}f&&(b=f)}for(b=h;l<M.length;l++){B=M[l];f=d>0&&!B.equals(g)?b.appendChild(B.clone()[0]):null;if(!o[l]||!B._4eSameLevel(o[l]))for(B=B[0].previousSibling;B;){L=B.previousSibling;if(d===2)b.insertBefore(B.cloneNode(t),b.firstChild);else{e._4eRemove(B);
d===1&&b.insertBefore(B,b.firstChild)}B=L}f&&(b=f)}if(d===2){if(i){G=c[0];if(G.nodeType===e.NodeType.TEXT_NODE&&G.nextSibling&&G.nextSibling.nodeType===e.NodeType.TEXT_NODE){G.data=G.data+G.nextSibling.data;G.parentNode.removeChild(G.nextSibling)}}if(k){k=g[0];if(k.nodeType===e.NodeType.TEXT_NODE&&k.previousSibling&&k.previousSibling.nodeType===e.NodeType.TEXT_NODE){k.previousSibling.data=k.previousSibling.data+k.data;k.parentNode.removeChild(k)}}}else{if(G&&I&&(!c._4eSameLevel(G)||!g._4eSameLevel(I))){k=
G._4eIndex();n&&G._4eSameLevel(c)&&k--;a.setStart(G.parent(),k+1)}a.collapse(t)}n&&c.remove();R&&g.remove();return h}function h(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function l(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=g;this.collapsed=t;this.document=a}b("./dom");var z=b("./utils"),k=b("./walker"),w=b("./base"),i=b("./element-path"),y=b("util");w.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var t=true,q=false,g=null,c=w.RangeType,f=w.PositionType,e=b("dom"),a=b("ua"),d=w.XHTML_DTD,p=b("node"),j={td:1},n={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},H=new k.whitespaces,I=new k.bookmark,A=k.whitespaces(t),J=k.bookmark(false,true),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,
i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};y.augment(l,{toString:function(){var a=[],d=this.startContainer[0],c=this.endContainer[0];a.push((d.id||d.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,d=this.startOffset;a[0].nodeType!==e.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;
d=this.endOffset;a[0].nodeType!==e.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,d=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);d&&d.nodeName()==="span"&&d.attr("_ke_bookmark")&&this.setEndAfter(d)},setStart:function(a,d){if(a[0].nodeType===e.NodeType.ELEMENT_NODE&&n[a.nodeName()]){a=a.parent();d=a._4eIndex()}this.startContainer=a;this.startOffset=d;if(!this.endContainer){this.endContainer=a;this.endOffset=d}h(this)},setEnd:function(a,d){if(a[0].nodeType===e.NodeType.ELEMENT_NODE&&n[a.nodeName()]){a=a.parent();d=a._4eIndex()+1}this.endContainer=a;this.endOffset=d;if(!this.startContainer){this.startContainer=
a;this.startOffset=d}h(this)},setStartAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}h(this)},setEndAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===
e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}h(this)},cloneContents:function(){return u(this,2)},deleteContents:function(){return u(this,0)},extractContents:function(){return u(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=t},clone:function(){var a=new l(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==e.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==e.NodeType.ELEMENT_NODE)return g;var d=new k(a);d.evaluator=function(a){return A(a)&&J(a)};a=d.next();d.reset();
d=d.previous();return a&&a.equals(d)?a:g},shrink:function(a,d){if(!this.collapsed){var a=a||c.SHRINK_TEXT,g=this.clone(),b=this.startContainer,p=this.endContainer,j=this.startOffset,f=this.endOffset,n=t,i,h,l=t;if(b&&b[0].nodeType===e.NodeType.TEXT_NODE)if(j)if(j>=b[0].nodeValue.length)g.setStartAfter(b);else{g.setStartBefore(b);n=q}else g.setStartBefore(b);if(p&&p[0].nodeType===e.NodeType.TEXT_NODE)if(f)if(f>=p[0].nodeValue.length)g.setEndAfter(p);else{g.setEndAfter(p);l=q}else g.setEndBefore(p);
if(n||l){h=new k(g);h.evaluator=function(d){return d.nodeType===(a===c.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)};h.guard=function(d,g){if(a===c.SHRINK_ELEMENT&&d.nodeType===e.NodeType.TEXT_NODE||g&&d===i)return q;!g&&d.nodeType===e.NodeType.ELEMENT_NODE&&(i=d);return t}}if(n)(g=h[a===c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,d?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(l){h.reset();(h=h[a===c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(h,
d?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return n||l}},createBookmark2:function(a){var d=this.startContainer,c=this.endContainer,b=this.startOffset,j=this.endOffset,f,n;if(!d||!c)return{start:0,end:0};if(a){if(d[0].nodeType===e.NodeType.ELEMENT_NODE)if((f=p(d[0].childNodes[b]))&&f[0]&&f[0].nodeType===e.NodeType.TEXT_NODE&&b>0&&f[0].previousSibling.nodeType===e.NodeType.TEXT_NODE){d=f;b=0}for(;d[0].nodeType===e.NodeType.TEXT_NODE&&(n=d.prev(void 0,1))&&n[0].nodeType===e.NodeType.TEXT_NODE;){d=
n;b=b+n[0].nodeValue.length}if(!this.collapsed){if(c[0].nodeType===e.NodeType.ELEMENT_NODE)if((f=p(c[0].childNodes[j]))&&f[0]&&f[0].nodeType===e.NodeType.TEXT_NODE&&j>0&&f[0].previousSibling.nodeType===e.NodeType.TEXT_NODE){c=f;j=0}for(;c[0].nodeType===e.NodeType.TEXT_NODE&&(n=c.prev(void 0,1))&&n[0].nodeType===e.NodeType.TEXT_NODE;){c=n;j=j+n[0].nodeValue.length}}}return{start:d._4eAddress(a),end:this.collapsed?g:c._4eAddress(a),startOffset:b,endOffset:j,normalized:a,is2:t}},createBookmark:function(a){var d,
e,b,j,f=this.collapsed;d=p("<span>",g,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");if(a){b=y.guid("ke_bm_");d.attr("id",b+"S")}if(!f){e=d.clone();e.html("&nbsp;");a&&e.attr("id",b+"E");j=this.clone();j.collapse();j.insertNode(e)}j=this.clone();j.collapse(t);j.insertNode(d);if(e){this.setStartAfter(d);this.setEndBefore(e)}else this.moveToPosition(d,c.POSITION_AFTER_END);return{startNode:a?b+"S":d,endNode:a?b+"E":e,serializable:a,collapsed:f}},moveToPosition:function(a,
d){this.setStartAt(a,d);this.collapse(t)},trim:function(a,d){var c=this.startContainer,g=this.startOffset,b=this.collapsed;if((!a||b)&&c[0]&&c[0].nodeType===e.NodeType.TEXT_NODE){if(g)if(g>=c[0].nodeValue.length){g=c._4eIndex()+1;c=c.parent()}else{var p=c._4eSplitText(g),g=c._4eIndex()+1,c=c.parent();if(e.equals(this.startContainer,this.endContainer))this.setEnd(p,this.endOffset-this.startOffset);else if(e.equals(c,this.endContainer))this.endOffset=this.endOffset+1}else{g=c._4eIndex();c=c.parent()}this.setStart(c,
g);if(b){this.collapse(t);return}}c=this.endContainer;g=this.endOffset;if(!d&&!b&&c[0]&&c[0].nodeType===e.NodeType.TEXT_NODE){if(g){g>=c[0].nodeValue.length||c._4eSplitText(g);g=c._4eIndex()+1}else g=c._4eIndex();c=c.parent();this.setEnd(c,g)}},insertNode:function(a){this.optimizeBookmark();this.trim(q,t);var d=this.startContainer;d[0].insertBefore(a[0],d[0].childNodes[this.startOffset]||null);d[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var d=p(this.document);
if(a.is2){var c=d._4eGetByAddress(a.start,a.normalized),e=a.startOffset,d=a.end&&d._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(c,e);d?this.setEnd(d,a):this.collapse(t)}else{c=(e=a.serializable)?p("#"+a.startNode,d):a.startNode;a=e?p("#"+a.endNode,d):a.endNode;this.setStartBefore(c);c._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(t)}},getCommonAncestor:function(a,d){var c=this.startContainer,g=this.endContainer,c=c[0]===g[0]?a&&c[0].nodeType===e.NodeType.ELEMENT_NODE&&
this.startOffset===this.endOffset-1?p(c[0].childNodes[this.startOffset]):c:c._4eCommonAncestor(g);return d&&c[0].nodeType===e.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(d,c,g,b){var m=d[c?"startContainer":"endContainer"],j,f=c?0:1,n=0,k=c?"previousSibling":"nextSibling";j=d[c?"startOffset":"endOffset"];if(m[0].nodeType===e.NodeType.TEXT_NODE){if(c){if(j)return}else if(j<m[0].nodeValue.length)return;j=m[0][k];m=m[0].parentNode}else{j=m[0].childNodes[j+(c?-1:1)]||null;m=m[0]}for(;m;){for(;j;)if(H(j)||
I(j))j=j[k];else break;if(j){if(!n)d[c?"setStartAfter":"setEndBefore"](p(j));break}m=p(m);if(m.nodeName()==="body")break;if(n||m.equals(b)){g[f]=m;n=1}else d[c?"setStartBefore":"setEndAfter"](m);j=m[0][k];m=m[0].parentNode}}return function(d){var b;switch(d){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var d=this.getCommonAncestor(),j=[];a(this,1,j,d);a(this,0,j,d);if(j[0]&&j[1]){d=j[0].contains(j[1])?j[1]:j[0];this.setStartBefore(d);this.setEndAfter(d)}break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:b=
new l(this.document);j=p(this.document.body);b.setStartAt(j,c.POSITION_AFTER_START);b.setEnd(this.startContainer,this.startOffset);b=new k(b);var f,n,i=k.blockBoundary(d===c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:g),h=function(a){var d=i(a);d||(f=p(a));return d},q=function(a){var d=h(a);!d&&e.nodeName(a)==="br"&&(n=p(a));return d};b.guard=h;b=b.lastBackward();f=f||j;this.setStartAt(f,f.nodeName()!=="br"&&(!b&&this.checkStartOfBlock()||b&&f.contains(b))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);b=this.clone();
b.collapse();b.setEndAt(j,c.POSITION_BEFORE_END);b=new k(b);b.guard=d===c.ENLARGE_LIST_ITEM_CONTENTS?q:h;f=g;b=b.lastForward();f=f||j;this.setEndAt(f,!b&&this.checkEndOfBlock()||b&&f.contains(b)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);n&&this.setEndAfter(n)}}}(),checkStartOfBlock:function(){var a=this.startContainer,d=this.startOffset;if(d&&a[0].nodeType===e.NodeType.TEXT_NODE&&y.trim(a[0].nodeValue.substring(0,d)).length)return q;this.trim();a=new i(this.startContainer);d=this.clone();d.collapse(t);
d.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new k(d);a.evaluator=o(t);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,d=this.endOffset;if(a[0].nodeType===e.NodeType.TEXT_NODE&&y.trim(a[0].nodeValue.substring(d)).length)return q;this.trim();a=new i(this.endContainer);d=this.clone();d.collapse(q);d.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new k(d);a.evaluator=o(q);return a.checkForward()},checkBoundaryOfElement:function(a,d){var e=this.clone();
e[d===c.START?"setStartAt":"setEndAt"](a,d===c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);e=new k(e);e.evaluator=s;return e[d===c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,d=this.endContainer,c=this.startOffset,g=this.endOffset,b;if(a[0].nodeType===e.NodeType.ELEMENT_NODE){b=a[0].childNodes.length;if(b>c)a=p(a[0].childNodes[c]);else if(b===0)a=a._4ePreviousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=p(a);a=a._4eNextSourceNode()||
a}}if(d[0].nodeType===e.NodeType.ELEMENT_NODE){b=d[0].childNodes.length;if(b>g)d=p(d[0].childNodes[g])._4ePreviousSourceNode(t);else if(b===0)d=d._4ePreviousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=p(d)}}a._4ePosition(d)&f.POSITION_FOLLOWING&&(a=d);return{startNode:a,endNode:d}},fixBlock:function(d,e){var g=this.createBookmark(),b=p(this.document.createElement(e));this.collapse(d);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);b[0].appendChild(this.extractContents());b._4eTrim();a.ie||b._4eAppendBogus();
this.insertNode(b);this.moveToBookmark(g);return b},splitBlock:function(d){var e=new i(this.startContainer),b=new i(this.endContainer),j=e.block,p=b.block,f=g;if(!e.blockLimit.equals(b.blockLimit))return g;if(d!=="br"){if(!j){j=this.fixBlock(t,d);p=(new i(this.endContainer)).block}p||(p=this.fixBlock(q,d))}d=j&&this.checkStartOfBlock();e=p&&this.checkEndOfBlock();this.deleteContents();if(j&&j[0]===p[0])if(e){f=new i(this.startContainer);this.moveToPosition(p,c.POSITION_AFTER_END);p=g}else if(d){f=
new i(this.startContainer);this.moveToPosition(j,c.POSITION_BEFORE_START);j=g}else{p=this.splitElement(j);!a.ie&&!y.inArray(j.nodeName(),["ul","ol"])&&j._4eAppendBogus()}return{previousBlock:j,nextBlock:p,wasStartOfBlock:d,wasEndOfBlock:e,elementPath:f}},splitElement:function(a){if(!this.collapsed)return g;this.setEndAt(a,c.POSITION_BEFORE_END);var d=this.extractContents(),e=a.clone(q);e[0].appendChild(d);e.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return e},moveToElementEditablePosition:function(a,
d){for(var g=0;a;){if(a[0].nodeType===e.NodeType.TEXT_NODE){this.moveToPosition(a,d?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);g=1;break}if(a[0].nodeType===e.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,d?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);g=1}var b=a,j=g,p=void 0;b[0].nodeType===e.NodeType.ELEMENT_NODE&&b._4eIsEditable()&&(p=b[d?"last":"first"](r,1));!j&&!p&&(p=b[d?"prev":"next"](r,1));a=p}return!!g},selectNodeContents:function(a){var d=a[0];this.setStart(a,0);this.setEnd(a,
d.nodeType===e.NodeType.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(a){var c,e,g,b=a.nodeName();c=d.$block[b];this.deleteContents();if(c){for(c=this.getCommonAncestor(q,t);(e=d[c.nodeName()])&&(!e||!e[b]);){var j=c.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(c);this.collapse(t);c.remove()}else g=c;c=j}g&&this.splitElement(g)}this.insertNode(a)}});z.injectDom({_4eBreakParent:function(a,d){var d=p(d),a=p(a),c,e=new w.Range(a[0].ownerDocument);
e.setStartAfter(a);e.setEndAfter(d);c=e.extractContents();e.insertNode(a.remove());a.after(c)}});w.Range=l;x.exports=l});
KISSY.add("editor/dom","util,node,./base,./utils,dom,ua".split(","),function(z,b){function C(g,c){var b=g[c?"next":"prev"](void 0,1);if(b&&b[0].nodeType===l.ELEMENT_NODE){for(var e=[];b.attr("_ke_bookmark")||b._4eIsEmptyInlineRemovable(void 0);){e.push(b);b=c?b.next(void 0,1):b.prev(void 0,1);if(!b)return}if(g._4eIsIdentical(b,void 0)){for(var a=s(c?g[0].lastChild:g[0].firstChild);e.length;)e.shift()._4eMove(g,!c,void 0);b._4eMoveChildren(g,!c,void 0);b.remove();a[0]&&a[0].nodeType===l.ELEMENT_NODE&&
a._4eMergeSiblings()}}}var x=b("util"),s=b("node"),r=b("./base"),o=b("./utils"),u=r.XHTML_DTD,h=b("dom"),l=h.NodeType,k=b("ua"),w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var i=r.PositionType,y={block:1,"list-item":1,
table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},t={hr:1},q=function(b){return b&&(b[0]||b)};o.injectDom({_4eSameLevel:function(b,c){var c=q(c),f=b.parentNode;return f&&f===c.parentNode},_4eIsBlockBoundary:function(b,c){var f=x.merge(t,c);return!(!y[h.css(b,"display")]&&!f[h.nodeName(b)])},_4eIndex:function(b,c){for(var f=b.parentNode.childNodes,e,a=-1,d=0;d<f.length;d++){e=f[d];if(!c||
!(e.nodeType===3&&e.previousSibling&&e.previousSibling.nodeType===3)){a++;if(e===b)return a}}return-1},_4eMove:function(b,c,f){c=q(c);f?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4eIsIdentical:function(b,c){if(!c)return false;c=q(c);if(h.nodeName(b)!==h.nodeName(c))return false;var f=b.attributes,e,a,d=c.attributes,p=f.length,j=d.length;if(p!==j)return false;for(var n=0;n<p;n++){e=f[n];a=e.name;if(e.specified&&h.attr(b,a)!==h.attr(c,a))return false}if(k.ieMode<8)for(n=0;n<j;n++){e=d[n];a=e.name;
if(e.specified&&h.attr(b,a)!==h.attr(c,a))return false}return true},_4eIsEmptyInlineRemovable:function(b){if(!u.$removeEmpty[h.nodeName(b)])return false;for(var b=b.childNodes,c=0,f=b.length;c<f;c++){var e=b[c],a=e.nodeType;if(!(a===l.ELEMENT_NODE&&e.getAttribute("_ke_bookmark"))&&(a===l.ELEMENT_NODE&&!h._4eIsEmptyInlineRemovable(e)||a===h.NodeType.TEXT_NODE&&x.trim(e.nodeValue)))return false}return true},_4eMoveChildren:function(b,c,f){c=q(c);if(b!==c)if(f)for(;f=b.lastChild;)c.insertBefore(b.removeChild(f),
c.firstChild);else for(;f=b.firstChild;)c.appendChild(b.removeChild(f))},_4eMergeSiblings:function(b){b=s(b);if(w[b.nodeName()]){C(b,true);C(b)}},_4eSplitText:function(b,c){var f=b.ownerDocument;if(b.nodeType===h.NodeType.TEXT_NODE){if(k.ie&&c===b.nodeValue.length){var e=f.createTextNode("");h.insertAfter(e,b);return e}e=b.splitText(c);if(f.documentMode){f=f.createTextNode("");h.insertAfter(f,e);h.remove(f)}return e}},_4eParents:function(b,c){var f=[];f.__IS_NODELIST=1;do f[c?"push":"unshift"](b);
while(b=b.parentNode);return f},_4eNextSourceNode:function(b,c,f,e){if(e&&!e.call)var a=q(e),e=function(d){return d!==a};var c=!c&&b.firstChild,d=b;if(!c){if(b.nodeType===l.ELEMENT_NODE&&e&&e(b,true)===false)return null;c=b.nextSibling}for(;!c&&(d=d.parentNode);){if(e&&e(d,true)===false)return null;c=d.nextSibling}return!c||e&&e(c)===false?null:f&&f!==c.nodeType?h._4eNextSourceNode(c,false,f,e):c},_4ePreviousSourceNode:function(b,c,f,e){if(e&&!e.call)var a=q(e),e=function(d){return d!==a};var c=!c&&
b.lastChild,d=b;if(!c){if(b.nodeType===l.ELEMENT_NODE&&e&&e(b,true)===false)return null;c=b.previousSibling}for(;!c&&(d=d.parentNode);){if(e&&e(d,true)===false)return null;c=d.previousSibling}return!c||e&&e(c)===false?null:f&&c.nodeType!==f?h._4ePreviousSourceNode(c,false,f,e):c},_4eCommonAncestor:function(b,c){c=q(c);if(b===c)return b;if(h.contains(c,b))return c;var f=b;do if(h.contains(f,c))return f;while(f=f.parentNode);return null},_4eHasAttributes:k.ieMode<9?function(b){for(var c=b.attributes,
f=0;f<c.length;f++){var e=c[f];switch(e.name){case "class":if(b.getAttribute("class"))return true;break;default:if(e.specified)return true}}return false}:function(b){k.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4ePosition:function(b,c){var f=q(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(f);if(b===f)return i.POSITION_IDENTICAL;if(b.nodeType===l.ELEMENT_NODE&&f.nodeType===l.ELEMENT_NODE){if(h.contains(b,f))return i.POSITION_CONTAINS+i.POSITION_PRECEDING;if(h.contains(f,
b))return i.POSITION_IS_CONTAINED+i.POSITION_FOLLOWING;if("sourceIndex"in b)return b.sourceIndex<0||f.sourceIndex<0?i.POSITION_DISCONNECTED:b.sourceIndex<f.sourceIndex?i.POSITION_PRECEDING:i.POSITION_FOLLOWING}for(var e=h._4eAddress(b),f=h._4eAddress(f),a=Math.min(e.length,f.length),d=0;d<=a-1;d++)if(e[d]!==f[d])return e[d]<f[d]?i.POSITION_PRECEDING:i.POSITION_FOLLOWING;return e.length<f.length?i.POSITION_CONTAINS+i.POSITION_PRECEDING:i.POSITION_IS_CONTAINED+i.POSITION_FOLLOWING},_4eAddress:function(b,
c){for(var f=[],e=b.ownerDocument.documentElement,a=b;a&&a!==e;){f.unshift(h._4eIndex(a,c));a=a.parentNode}return f},_4eRemove:function(b,c){var f=b.parentNode;if(f){if(c)for(var e;e=b.firstChild;)f.insertBefore(b.removeChild(e),b);f.removeChild(b)}return b},_4eTrim:function(b){h._4eLtrim(b);h._4eRtrim(b)},_4eLtrim:function(b){for(var c;c=b.firstChild;){if(c.nodeType===h.NodeType.TEXT_NODE){var f=o.ltrim(c.nodeValue),e=c.nodeValue.length;if(f){if(f.length<e){h._4eSplitText(c,e-f.length);b.removeChild(b.firstChild)}}else{b.removeChild(c);
continue}}break}},_4eRtrim:function(b){for(var c;c=b.lastChild;){if(c.type===h.NodeType.TEXT_NODE){var f=o.rtrim(c.nodeValue),e=c.nodeValue.length;if(f){if(f.length<e){h._4eSplitText(c,f.length);b.removeChild(b.lastChild)}}else{b.removeChild(c);continue}}break}if(!k.ie)(c=b.lastChild)&&c.nodeType===1&&h.nodeName(c)==="br"&&b.removeChild(c)},_4eAppendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType===h.NodeType.TEXT_NODE&&!x.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType===h.NodeType.TEXT_NODE||
h.nodeName(c)!=="br"){c=b.ownerDocument.createElement("br");b.appendChild(c)}},_4eSetMarker:function(b,c,f,e){var b=s(b),a=b.data("list_marker_id")||b.data("list_marker_id",x.guid()).data("list_marker_id"),d=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[a]=b;d[f]=1;return b.data(f,e)},_4eClearMarkers:function(b,c,f){var b=s(b),e=b.data("list_marker_names"),a=b.data("list_marker_id"),d;for(d in e)b.removeData(d);b.removeData("list_marker_names");if(f){b.removeData("list_marker_id");
delete c[a]}},_4eCopyAttributes:function(b,c,f){for(var c=s(c),e=b.attributes,f=f||{},a=0;a<e.length;a++){var d=e[a],p=d.name.toLowerCase(),j;if(!(p in f))if(p==="checked"&&(j=h.attr(b,p)))c.attr(p,j);else if(d.specified||k.ie&&d.value&&p==="value"){j=h.attr(b,p);if(j===null)j=d.nodeValue;c.attr(p,j)}}if(b.style.cssText!=="")c[0].style.cssText=b.style.cssText},_4eIsEditable:function(b){b=h.nodeName(b);return(b=!u.$nonEditable[b]&&(u[b]||u.span))&&b["#text"]},_4eGetByAddress:function(b,c,f){for(var b=
b.documentElement,e=0;b&&e<c.length;e++){var a=c[e];if(f)for(var d=-1,p=0;p<b.childNodes.length;p++){var j=b.childNodes[p];if(!(f===true&&j.nodeType===3&&j.previousSibling&&j.previousSibling.nodeType===3)){d++;if(d===a){b=j;break}}}else b=b.childNodes[a]}return b}})});
KISSY.add("editor/walker",["./base","util","ua","dom","node"],function(z,b,C,x){function s(b,a){if(this._.end)return k;var d,c=this.range,j,f=this.guard,g=this.type,q=b?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,c.trim(),c.collapsed))return this.end(),k;if(!b&&!this._.guardLTR){var o=c.endContainer[0],r=o.childNodes[c.endOffset];this._.guardLTR=function(a,d){return d&&(o===a||"body"===i.nodeName(a))?!1:a!==r}}if(b&&!this._.guardRTL){var w=c.startContainer[0],m=0<
c.startOffset&&w.childNodes[c.startOffset-1]||null;this._.guardRTL=function(a,d){return d&&(w===a||"body"===i.nodeName(a))?!1:a!==m}}var s=b?this._.guardRTL:this._.guardLTR;j=f?function(a,d){return s(a,d)===l?l:f(a,d)}:s;this.current?d=this.current[q](l,g,j):b?(d=c.endContainer,0<c.endOffset?(d=t(d[0].childNodes[c.endOffset-1]),j(d[0])===l&&(d=k)):d=j(d,h)===l?k:d._4ePreviousSourceNode(h,g,j,void 0)):(d=c.startContainer,d=t(d[0].childNodes[c.startOffset]),d.length?j(d[0])===l&&(d=k):d=j(c.startContainer,
h)===l?k:c.startContainer._4eNextSourceNode(h,g,j,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==l){if(!a)return d}else if(a&&this.evaluator)return l;d=d[q](l,g,j)}this.end();return this.current=k}function r(b){for(var a,d=k;a=s.call(this,b);)d=a;return d}function o(b){this.range=b;this.guard=this.evaluator=k;this._={}}var z=b("./base"),u=b("util"),h=!0,l=!1,k=null,w=b("ua"),i=b("dom"),y=z.XHTML_DTD,t=b("node");u.augment(o,{end:function(){this._.end=1},next:function(){return s.call(this)},
previous:function(){return s.call(this,h)},checkForward:function(){return s.call(this,l,h)!==l},checkBackward:function(){return s.call(this,h,h)!==l},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,h)},reset:function(){delete this.current;this._={}},_iterator:s});u.mix(o,{blockBoundary:function(b){return function(a){return!(a.nodeType===i.NodeType.ELEMENT_NODE&&i._4eIsBlockBoundary(a,b))}},bookmark:function(b,a){function d(a){return"span"===i.nodeName(a)&&i.attr(a,
"_ke_bookmark")}return function(c){var j,f;j=c.nodeType===i.NodeType.TEXT_NODE&&(f=c.parentNode)&&d(f);j=b?j:j||d(c);return!!(a^j)}},whitespaces:function(b){return function(a){a=a.nodeType===i.NodeType.TEXT_NODE&&!u.trim(a.nodeValue);return!!(b^a)}},invisible:function(b){var a=o.whitespaces();return function(d){d=a(d)||d.nodeType===i.NodeType.ELEMENT_NODE&&!d.offsetHeight;return!!(b^d)}}});var q=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,g=o.whitespaces(),c=o.bookmark(),f=function(b){var a=i.nodeName(b);return c(b)||
g(b)||1===b.nodeType&&a in y.$inline&&!(a in y.$empty)};z.Utils.injectDom({_4eGetBogus:function(b){b=t(b);do b=b._4ePreviousSourceNode();while(b&&f(b[0]));return b&&(!w.ie?"br"===b.nodeName():3===b[0].nodeType&&q.test(b.text()))?b[0]:!1}});z.Walker=o;x.exports=o});
KISSY.add("editor/element-path",["./base","./dom","dom"],function(z,b,C,x){function s(b){for(var w=u,i=u,s=[];b;){if(b[0].nodeType===r.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=b);var t=b.nodeName();if(!i&&(!w&&h[t]&&(w=b),l[t])){var q;if(q=!w)if(q="div"===t){a:{q=b[0].childNodes;for(var g=0,c=q.length;g<c;g++){var f=q[g];if(f.nodeType===r.NodeType.ELEMENT_NODE&&o.$block[f.nodeName.toLowerCase()]){q=!0;break a}}q=!1}q=!q}q?w=b:i=b}s.push(b);if("body"===t)break}b=b.parent()}this.block=
w;this.blockLimit=i;this.elements=s}z=b("./base");b("./dom");var r=b("dom"),o=z.XHTML_DTD,u=null,h={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},l={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};s.prototype={constructor:s,compare:function(b){var h=this.elements,b=b&&b.elements;if(!b||h.length!==b.length)return!1;for(var i=0;i<h.length;i++)if(!r.equals(h[i],b[i]))return!1;return!0},contains:function(b){for(var h=this.elements,i=0;i<h.length;i++)if(h[i].nodeName()in
b)return h[i];return u},toString:function(){var b=this.elements,h,i=[];for(h=0;h<b.length;h++)i.push(b[h].nodeName());return i.toString()}};z.ElementPath=s;x.exports=s});
KISSY.add("editor/selection","util,node,./walker,./range,./base,ua,dom".split(","),function(z,b,C,x){function s(a){this.document=a;this._={cache:{}};if(q)try{var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!==a||d.parentElement&&d.parentElement().ownerDocument!==a)this.isInvalid=l}catch(b){this.isInvalid=l}}function r(a){a=new s(a);return!a||a.isInvalid?k:a}var z=b("util"),o=b("node"),C=b("./walker"),u=b("./range"),h=b("./base");h.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,
SELECTION_ELEMENT:3};var l=true,k=null,w=b("ua"),i=b("dom"),y=h.SelectionType,t=h.RangeType,q=document.selection,g={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};z.augment(s,{getNative:!q?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=i.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!q?function(){var a=
this._.cache;if(a.type)return a.type;var d=y.SELECTION_TEXT,b=this.getNative();if(b){if(b.rangeCount===1){var b=b.getRangeAt(0),c=b.startContainer;if(c===b.endContainer&&c.nodeType===i.NodeType.ELEMENT_NODE&&Number(b.endOffset-b.startOffset)===1&&g[c.childNodes[b.startOffset].nodeName.toLowerCase()])d=y.SELECTION_ELEMENT}}else d=y.SELECTION_NONE;return a.type=d}:function(){var a=this._.cache;if(a.type)return a.type;var b=y.SELECTION_NONE;try{var c=this.getNative(),e=c.type;if(e==="Text")b=y.SELECTION_TEXT;
if(e==="Control")b=y.SELECTION_ELEMENT;if(c.createRange().parentElement)b=y.SELECTION_TEXT}catch(f){}return a.type=b},getRanges:q?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),e=c.childNodes,f,g=0;g<e.length;g++){var h=e[g];if(h.nodeType===i.NodeType.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(h);var h=f.compareEndPoints("StartToStart",a),q=f.compareEndPoints("EndToStart",a);f.collapse();if(h>0)break;else{if(!h||q===1&&h===-1)return{container:c,offset:g};
if(!q)return{container:c,offset:g+1}}f=k}}if(!f){f=a.duplicate();f.moveToElementText(c);f.collapse(false)}f.setEndPoint("StartToStart",a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;f>0;)f=f-e[--g].nodeValue.length}catch(l){f=0}return f===0?{container:c,offset:g}:{container:e[g],offset:-f}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var e=this.getNative(),b=e&&e.createRange(),f=this.getType();if(!e)return[];if(f===y.SELECTION_TEXT){e=new u(this.document);f=a(b,
l);e.setStart(o(f.container),f.offset);f=a(b);e.setEnd(o(f.container),f.offset);c.ranges=[e];return[e]}if(f===y.SELECTION_ELEMENT){c=c.ranges=[];for(f=0;f<b.length;f++){for(var g=b.item(f),h=g.parentNode,i=0,e=new u(this.document);i<h.childNodes.length&&h.childNodes[i]!==g;i++);e.setStart(o(h),i);e.setEnd(o(h),i+1);c.push(e)}return c}c.ranges=[];return[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var e=0;e<c.rangeCount;e++){var f=
c.getRangeAt(e),g=new u(this.document);g.setStart(o(f.startContainer),f.startOffset);g.setEnd(o(f.endContainer),f.endOffset);a.push(g)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(a.startElement!==void 0)return a.startElement;var b,c=this.getNative();switch(this.getType()){case y.SELECTION_ELEMENT:return this.getSelectedElement();case y.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();l;){b=e.startContainer;if(e.startOffset===(b[0].nodeType===i.NodeType.ELEMENT_NODE?
b[0].childNodes.length:b[0].nodeValue.length)&&!b._4eIsBlockBoundary())e.setStartAfter(b);else break}b=e.startContainer;if(b[0].nodeType!==i.NodeType.ELEMENT_NODE)return b.parent();b=o(b[0].childNodes[e.startOffset]);if(!b[0]||b[0].nodeType!==i.NodeType.ELEMENT_NODE)return e.startContainer;for(e=b[0].firstChild;e&&e.nodeType===i.NodeType.ELEMENT_NODE;){b=o(e);e=e.firstChild}return b}if(q){e=c.createRange();e.collapse(l);b=o(e.parentElement())}else{if((b=c.anchorNode)&&b.nodeType!==i.NodeType.ELEMENT_NODE)b=
b.parentNode;b&&(b=o(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;if(b.selectedElement!==void 0)return b.selectedElement;if(q){a=this.getNative().createRange();a=a.item&&a.item(0)}var c;if(a)c=o(a);else{a=this.getRanges()[0];for(var e,f=2;f&&(!(c=a.getEnclosedNode())||!(c[0].nodeType===i.NodeType.ELEMENT_NODE&&g[c.nodeName()]&&(e=c)));f--)a.shrink(t.SHRINK_ELEMENT);c=e}a=c;return b.selectedElement=a},reset:function(){this._.cache={}},selectElement:function(a){var b,
c=this.document;if(q)try{b=c.body.createControlRange();b.addElement(a[0]);b.select()}catch(e){b=c.body.createTextRange();b.moveToElementText(a[0]);b.select()}finally{}else{b=c.createRange();b.selectNode(a[0]);a=this.getNative();a.removeAllRanges();a.addRange(b)}this.reset()},selectRanges:function(a){if(q){if(a.length>1){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var e=
a[c],f=this.document.createRange(),g=e.startContainer;if(e.collapsed&&(w.gecko&&w.gecko<1.09||w.webkit)&&g[0].nodeType===i.NodeType.ELEMENT_NODE&&!g[0].childNodes.length){g[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":""));e.startOffset++;e.endOffset++}f.setStart(g[0],e.startOffset);f.setEnd(e.endContainer[0],e.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),e=0;e<c.length;e++)b.push(c[e].createBookmark2(a));return b},createBookmarks:function(a,
b){for(var c=[],e=this.document,f,b=b||this.getRanges(),g=b.length,h=0;h<g;h++){c.push(f=b[h].createBookmark(a,l));var k=(a=f.serializable)?o("#"+f.startNode,e):f.startNode;f=a?o("#"+f.endNode,e):f.endNode;for(var q=h+1;q<g;q++){var t=b[q],m=t.startContainer,r=t.endContainer;i.equals(m,k.parent())&&t.startOffset++;i.equals(m,f.parent())&&t.startOffset++;i.equals(r,k.parent())&&t.endOffset++;i.equals(r,f.parent())&&t.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var e=
new u(this.document);e.moveToBookmark(a[c]);b.push(e)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4eCommonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true})},removeAllRanges:function(){var a=this.getNative();q?a&&a.clear():a&&a.removeAllRanges()}});var c={table:1,tbody:1,tr:1},f=C.whitespaces(l),
e=/\ufeff|\u00a0/;u.prototype.select=!q?function(){var a=this.startContainer;if(this.collapsed&&a[0].nodeType===i.NodeType.ELEMENT_NODE&&!a[0].childNodes.length){a[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":""));this.startOffset++;this.endOffset++}var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(l);b.setEnd(this.endContainer[0],this.endOffset)}else throw c;
}a=r(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,g,j;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset===1){var h=this.startContainer[0].childNodes[this.startOffset];if(h.nodeType===i.NodeType.ELEMENT_NODE){(new s(this.document)).selectElement(o(h));return}}(this.startContainer[0].nodeType===i.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType===i.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in
c)&&this.shrink(t.SHRINK_ELEMENT,l);var k=this.createBookmark(),h=k.startNode,q;if(!b)q=k.endNode;k=this.document.body.createTextRange();k.moveToElementText(h[0]);k.moveStart("character",1);if(q){a=this.document.body.createTextRange();a.moveToElementText(q[0]);k.setEndPoint("EndToEnd",a);k.moveEnd("character",-1)}else{for(g=h[0].nextSibling;g&&!f(g);)g=g.nextSibling;g=!(g&&g.nodeValue&&g.nodeValue.match(e))&&(a||!h[0].previousSibling||h[0].previousSibling&&i.nodeName(h[0].previousSibling)==="br");
j=o(this.document.createElement("span"));j.html("&#65279;");j.insertBefore(h);g&&i.insertBefore(this.document.createTextNode("\ufeff"),h[0]||h)}this.setStartBefore(h);h._4eRemove();if(b){if(g){k.moveStart("character",-1);k.select();this.document.selection.clear()}else k.select();if(j){this.moveToPosition(j,t.POSITION_BEFORE_START);j._4eRemove()}}else{this.setEndBefore(q);q._4eRemove();k.select()}};s.getSelection=r;h.Selection=s;x.exports=s});
KISSY.add("editor/enter-key","util,node,ua,./walker,./base,./element-path".split(","),function(z,b,C){function x(b){var q;q=b.getSelection().getRanges();for(var g=q.length-1;g>0;g--)q[g].deleteContents();q=q[0];var g=q.document,c=new k(q.startContainer),f=q.checkStartOfBlock(),e=q.checkEndOfBlock(),c=c.block;if(f&&e){if(c&&(c.nodeName()==="li"||c.parent().nodeName()==="li")){if(b.hasCommand("outdent")){b.execCommand("save");b.execCommand("outdent");b.execCommand("save");return true}return false}}else if(c&&
c.nodeName()==="pre"&&!e){var a=u.ieMode<9?o(g.createTextNode("\r")):o(g.createElement("br"));q.insertNode(a);if(u.ieMode<9){a=o(g.createTextNode("\ufeff")).insertAfter(a);q.setStartAt(a,l.RangeType.POSITION_AFTER_START)}else q.setStartAfter(a);q.collapse(true);q.select();if(u.ieMode<9)a[0].nodeValue="";return}var d=q.splitBlock("p");if(!d)return true;var b=d.previousBlock,c=d.nextBlock,f=d.wasStartOfBlock,e=d.wasEndOfBlock,p;if(c){p=c.parent();if(p.nodeName()==="li"){c._4eBreakParent(p);c._4eMove(c.next(),
true)}}else if(b&&(p=b.parent())&&p.nodeName()==="li"){b._4eBreakParent(p);q.moveToElementEditablePosition(b.next());b._4eMove(b.prev())}if(!f&&!e){if(c.nodeName()==="li"&&(p=c.first(h.invisible(true)))&&r.inArray(p.nodeName(),["ul","ol"]))(w?o(g.createTextNode("\u00a0")):o(g.createElement("br"))).insertBefore(p);c&&q.moveToElementEditablePosition(c)}else{if(b){if(b.nodeName()==="li"||!i.test(b.nodeName()))a=b.clone()}else c&&(a=c.clone());a||(a=o("<p>",null,g));if(p=d.elementPath)for(var d=0,j=p.elements.length;d<
j;d++){var n=p.elements[d];if(n.equals(p.block)||n.equals(p.blockLimit))break;if(y.$removeEmpty[n.nodeName()]){n=n.clone();a._4eMoveChildren(n);a.append(n)}}w||a._4eAppendBogus();q.insertNode(a);if(w&&f&&(!e||!b[0].childNodes.length)){q.moveToElementEditablePosition(e?b:a);q.select()}q.moveToElementEditablePosition(f&&!e?c:a)}if(!w)if(c){a=o(g.createElement("span"));a.html("&nbsp;");q.insertNode(a);a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});q.deleteContents()}else a.scrollIntoView(void 0,
{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});q.select();return true}function s(b){b.get("document").on("keydown",function(h){if(h.keyCode===13&&!h.shiftKey&&!h.ctrlKey&&!h.metaKey){b.execCommand("save");var g=b.execCommand("enterBlock");b.execCommand("save");g!==false&&h.preventDefault()}})}var r=b("util"),o=b("node"),u=b("ua"),h=b("./walker"),l=b("./base"),k=b("./element-path"),w=u.ieMode<11,i=/^(?:h[1-6])|(?:pre)$/i,y=l.XHTML_DTD;C.init=function(b){b.addCommand("enterBlock",
{exec:x});b.docReady(function(){s(b)})}});
KISSY.add("editor/html-data-processor",["html-parser","ua","node","util"],function(z,b,C){function x(b){if(!h.$removeEmpty[b.nodeName])return!1;var b=b.childNodes,i,k,o=b.length;if(o)for(i=0;i<o;i++)if(k=b[i],k.nodeType!==l.TEXT_NODE||k.nodeValue||!x(k))return!1;return!0}var s=b("html-parser"),r=b("ua"),o=11>r.ieMode,u=b("node"),h=s.DTD,l=u.Dom.NodeType,k=b("util");C.init=function(b){function i(a){return!x(a)}function l(a){return a.replace(f,function(a,b,c){return"<"+b+c.replace(e,function(a,b){return-1===
c.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function t(a){return a.replace(d,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function q(a){return a.replace(p,function(a,b){return k.urlDecode(b)})}var g=new s.Filter,c=new s.Filter;(function(){function b(c){c=s.serialize(c);return new s.Comment(a+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var d={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,
noscript:b,span:i}},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=["name","href","src"],c,d=0;d<b.length;d++)c="_keSaved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:i,strong:i,
em:i,del:i,u:i},attributes:{style:function(a){if(!k.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,a.length)===a)return b=k.trim(k.urlDecode(b.substr(a.length))),s.parse(b).childNodes[0]}};o&&(e.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});g.addRules(e);c.addRules(d)})();(function(){function a(b){for(var b=b.childNodes,c=b.length,d=b[c-1];d&&(3===
d.nodeType&&!k.trim(d.nodeValue)||1===d.nodeType&&x(d));)d=b[--c];return d}function b(c){var d=a(c);d&&(1===d.nodeType&&"br"===d.nodeName?c.removeChild(d):3===d.nodeType&&j.test(d.nodeValue)&&c.removeChild(d))}function d(b){var c=a(b);return!c||"form"===b.nodeName&&"input"===c.nodeName}function e(a){b(a);d(a)&&(o||a.appendChild(new s.Tag("br")))}function f(a){b(a);d(a)&&a.appendChild(new s.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,i=k.merge(h.$block,h.$listItem,h.$tableContent),p;for(p in i)"br"in
h[p]||delete i[p];delete i.pre;var n={tags:{}},q={tags:{}};for(p in i)n.tags[p]=e,q.tags[p]=f;c.addRules(n);g.addRules(q)})();g.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var f=/<(a|area|img|input)\b([^>]*)>/gi,e=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}",d=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,p=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
j=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,n=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,z=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;b.htmlDataProcessor={dataFilter:c,htmlFilter:g,toHtml:function(a){r.webkit&&(a=a.replace(/\u200b/g,""));var b=new s.BeautifyWriter;(new s.Parser(a)).parse().writeHtml(b,g);return a=b.getHtml()},toDataFormat:function(a,b){var b=b||c,a=t(a),a=l(a),a=a.replace(j,"$1ke:$2"),a=a.replace(z,"<ke:$1$2></ke:$1>"),
d=u("<div>");d.html("a"+a);a=d.html().substr(1);a=a.replace(n,"$1$2");a=q(a);d=new s.BasicWriter;(new s.Parser(a)).parse().writeHtml(d,b);return a=d.getHtml()},toServer:function(a){var b=new s.MinifyWriter;(new s.Parser(a)).parse().writeHtml(b,g);return b.getHtml()}}}});
KISSY.add("editor/selection-fix",["./base","./selection","node","ua","dom"],function(z,b,C){function x(b){function g(a,b){var c=h.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=w}return c}function c(){var a=h.selection.createRange();j&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&j.select();d.detach("mouseup",c);d.detach("mousemove",f);j=e=0}function f(a){if(a.button){if(a=g(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",j)?a.setEndPoint("StartToStart",j):a.setEndPoint("EndToEnd",
j),a.select()}else c()}var e,a=b.get("window")[0],d=b.get("document"),h=d[0],j;d.on("mousedown contextmenu",function(b){var i=h.documentElement;if(b.target===i&&(e&&c(),!(i.scrollHeight>i.clientHeight)&&(e=1,j=g(b.pageX,b.pageY))))d.on("mouseup",c),d.on("mousemove",f),a.focus(),j.select()})}function s(b){function g(e){if(d){var f=b.getSelection(),h=f&&f.getType(),i=f&&c.selection;if(e&&i&&h===t.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){g(l)},50);else{var k;if(!i||
!i.type||!("Control"!==i.type&&(k=i.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))a=i&&f.getRanges()[0],b.checkSelectionChange()}}}var c=b.get("document")[0],f=h(c.body),e=h(c.documentElement);if(8>i.ieMode)e.on("click",function(a){"html"===h(a.target).nodeName()&&b.getSelection().getNative().createRange().select()});var a,d,p=l;e.on("mousedown",function(){p=k});e.on("mouseup",function(){p=l});f.on("focusin",function(b){if("body"===h(b.target).nodeName()&&
a){try{p&&a.select()}catch(c){}a=w}});f.on("focus",function(){d=l;g()});f.on("beforedeactivate",function(a){a.relatedTarget||(d=k,p=l)});f.on("mousedown",function(){d=k});f.on("mouseup",function(){d=l;setTimeout(function(){g(l)},0)});f.on("keydown",function(){d=k});f.on("keyup",function(){d=l;setTimeout(function(){g()},0)})}function r(b){b.get("document").on("mouseup keyup selectionchange",function(){b.checkSelectionChange()})}function o(b){function g(a){var b=u.XHTML_DTD;return a._4eIsBlockBoundary()&&
b.$empty[a.nodeName()]}function c(b){return e(b)&&a(b)}var f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,e=u.Walker.whitespaces(l),a=u.Walker.bookmark(k,l),d=function(a){return e(a)&&8!==a.nodeType};b.on("selectionChange",function(a){var e=a.path,n=b.get("document")[0],o=h(n.body),a=(a=a.selection)&&a.getRanges()[0],r=e.blockLimit;o[0]||(n.documentElement.appendChild(n.createElement("body")),o=h(n.body),a&&(a.setStart(o,
0),a.collapse(1)));r=r||o;if(i.gecko){var s=(n=e.block||e.blockLimit)&&n.last(c);n&&n._4eIsBlockBoundary()&&(!s||!(1===s[0].nodeType&&s._4eIsBlockBoundary()))&&"pre"!==n.nodeName()&&!n._4eGetBogus()&&n._4eAppendBogus()}if(a&&a.collapsed&&!e.block){if("body"===r.nodeName()){"html"===a.startContainer.nodeName()&&a.setStart(o,0);if((e=a.fixBlock(l,"p"))&&e[0]!==o[0].lastChild&&e.outerHtml().match(f))if((n=e.next(d,1))&&n[0].nodeType===y.NodeType.ELEMENT_NODE&&!g[n])a.moveToElementEditablePosition(n),
e._4eRemove();else if((n=e.prev(d,1))&&n[0].nodeType===y.NodeType.ELEMENT_NODE&&!g[n])a.moveToElementEditablePosition(n,n.outerHtml().match(f)?k:l),e._4eRemove();a.select();b.notifySelectionChange()}e=b.get("document")[0];a=new u.Range(e);a.moveToElementEditablePosition(o,l);"body"!==(new u.ElementPath(a.startContainer)).blockLimit.nodeName()&&(o=h(e.createElement("p")).appendTo(o),i.ie||o._4eAppendBogus())}})}var u=b("./base");b("./selection");var h=b("node"),l=!0,k=!1,w=null,i=b("ua"),y=b("dom"),
t=u.SelectionType;C.init=function(b){b.docReady(function(){if(document.selection)x(b),s(b);else if(r(b),i.ie){var g,c=b.get("document");c.on("focusout",function(){g=b.getSelection().getRanges()});c.on("focusin",function(){g&&(b.getSelection().selectRanges(g),g=null)})}});o(b)}});
KISSY.add("editor/styles","util,./selection,./range,./base,./element-path,node,dom,ua".split(","),function(z,b,C,x){function s(a){return!D.attr(a,"_ke_bookmark")}function r(a,b){for(var c in a)typeof a[c]==="string"?a[c]=a[c].replace(T,function(a,c){return b[c]}):r(a[c],b)}function o(a,b){if(b){a=j.clone(a);r(a,b)}var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type=c==="#text"||P[c]?K.STYLE_BLOCK:S[c]?K.STYLE_OBJECT:K.STYLE_INLINE;this._={definition:a}}function u(a,
b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=new n(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function h(a,b,c){var d=a.element;d==="*"&&(d="span");b=m(b.createElement(d));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=o.getStyleText(c);if(a)for(var e in a)b.attr(e,a[e]);if(c)b[0].style.cssText=c;return b}function l(a){var b=a.createBookmark(A),c=a.createIterator();c.enforceRealBlocks=A;c.enlargeBr=A;for(var d,e=a.document;d=
c.getNextParagraph();){var f=h(this,e,d),g=f,f=g.nodeName==="pre",j=d.nodeName==="pre",l=!f&&j;if(f&&!j){j=d;l=j.html();l=k(l,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,"");l=l.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1");l=l.replace(/([\t\n\r]+|&nbsp;)/g," ");l=l.replace(/<br\b[^>]*>/gi,"\n");if(O.ie){j=j[0].ownerDocument.createElement("div");j.appendChild(g[0]);g.outerHtml("<pre>"+l+"</pre>");g=m(j.firstChild);g._4eRemove()}else g.html(l)}else l?g=i(w(d),g):d._4eMoveChildren(g);d[0].parentNode.replaceChild(g[0],
d[0]);if(f){d=g;f=void 0;if((f=d._4ePreviousSourceNode(A,D.NodeType.ELEMENT_NODE))&&f.nodeName()==="pre"){g=k(f.html(),/\n$/,"")+"\n\n"+k(d.html(),/^\n/,"");O.ie?d.outerHtml("<pre>"+g+"</pre>"):d.html(g);f._4eRemove()}}}a.moveToBookmark(b)}function k(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function w(a){var b=[];k(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(a,b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function i(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=k(e,/^[\t]*\n/,""),e=k(e,/\n$/,""),e=k(e,/^[\t]+|[\t]+$/g,function(a,b){return a.length===1?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(e);c.appendChild(f[0])}return c}function y(b){var c=b.document;if(b.collapsed){c=h(this,c,void 0);b.insertNode(c);b.moveToPosition(c,v.POSITION_BEFORE_END)}else{var d=this.element,e=this._.definition,f,g=N[d];if(!g){f=A;g=N.span}var i=b.createBookmark();b.enlarge(v.ENLARGE_ELEMENT);b.trim();for(var j=b.createBookmark(),k=j.startNode,j=j.endNode,l=k,p;l&&l[0];){var n=J;if(D.equals(l,j)){l=F;n=A}else{var o=l[0].nodeType,q=o===D.NodeType.ELEMENT_NODE?l.nodeName():F;if(q&&l.attr("_ke_bookmark")){l=
l._4eNextSourceNode(A);continue}if(!q||g[q]&&(l._4ePosition(j)|E.POSITION_PRECEDING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(l))){var r=l.parent();if(r&&d==="a"&&r.nodeName()===d){o=h(this,c,void 0);r._4eMoveChildren(o);r[0].parentNode.replaceChild(o[0],r[0]);o._4eMergeSiblings()}else if(r&&r[0]&&((N[r.nodeName()]||N.span)[d]||f)&&(!e.parentRule||e.parentRule(r))){if(!p&&(!q||!N.$removeEmpty[q]||(l._4ePosition(j)|
E.POSITION_PRECEDING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED)){p=new H(c);p.setStartBefore(l)}if(o===D.NodeType.TEXT_NODE||o===D.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){r=l;for(o=null;(n=!r.next(s,1))&&(o=r.parent())&&g[o.nodeName()]&&(o._4ePosition(k)|E.POSITION_FOLLOWING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_FOLLOWING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(o));)r=
o;p.setEndAfter(r)}}else n=A}else n=A;l=l._4eNextSourceNode()}if(n&&p&&!p.collapsed){for(var n=h(this,c,void 0),r=p.getCommonAncestor(),o={},q={},t,u=null,w;n&&r&&n[0]&&r[0];){if(r.nodeName()===d){for(t in e.attributes)if(!q[t]&&(w=r.attr(u)))n.attr(t)===w?n.removeAttr(t):q[t]=1;for(u in e.styles)if(!o[u]&&(w=r.style(u)))n.style(u)===w?n.style(u,""):o[u]=1;if(!n._4eHasAttributes()){n=F;break}}r=r.parent()}if(n){n[0].appendChild(p.extractContents());a(this,n);p.insertNode(n);n._4eMergeSiblings();O.ie||
n[0].normalize()}else{n=m(c.createElement("span"));n[0].appendChild(p.extractContents());p.insertNode(n);a(this,n);n._4eRemove(true)}p=F}}k._4eRemove();j._4eRemove();b.moveToBookmark(i);b.shrink(v.SHRINK_TEXT)}}function t(a){a.enlarge(v.ENLARGE_ELEMENT);var b=a.createBookmark(),e=b.startNode;if(a.collapsed){for(var g=new I(e.parent()),h,i=0,j;i<g.elements.length&&(j=g.elements[i]);i++){if(j.equals(g.block)||j.equals(g.blockLimit))break;if(this.checkElementRemovable(j)){var k=a.checkBoundaryOfElement(j,
v.END),l=!k&&a.checkBoundaryOfElement(j,v.START);if(l||k){h=j;h.match=l?"start":"end"}else{j._4eMergeSiblings();if(j.nodeName()!==this.element){k=c(this);d(j,k[j.nodeName()]||k["*"])}else f(this,j)}}}if(h){j=e;for(i=0;;i++){k=g.elements[i];if(k.equals(h))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(j[0]);j=k}j[h.match==="start"?"insertBefore":"insertAfter"](h);g=h.html();!g||g==="\u200b"?h.remove():O.webkit&&m(a.document.createTextNode("\u200b")).insertBefore(j)}}else{var n=b.endNode,o=
this;h=function(){for(var a=new I(e.parent()),b=new I(n.parent()),c=F,d,f=F,g=0;g<a.elements.length;g++){d=a.elements[g];if(d===a.block||d===a.blockLimit)break;o.checkElementRemovable(d)&&(c=d)}for(g=0;g<b.elements.length;g++){d=b.elements[g];if(d===b.block||d===b.blockLimit)break;o.checkElementRemovable(d)&&(f=d)}f&&n._4eBreakParent(f);c&&e._4eBreakParent(c)};h();for(g=m(e[0].nextSibling);g[0]!==n[0];){i=g._4eNextSourceNode();if(g[0]&&g[0].nodeType===D.NodeType.ELEMENT_NODE&&this.checkElementRemovable(g)){if(g.nodeName()===
this.element)f(this,g);else{j=c(this);d(g,j[g.nodeName()]||j["*"])}if(i[0].nodeType===D.NodeType.ELEMENT_NODE&&i.contains(e)){h();i=m(e[0].nextSibling)}}g=i}}a.moveToBookmark(b)}function q(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function g(a,b){var c="";if(b!==J){c=document.createElement("span");c.style.cssText=a;c=c.style.cssText||""}else c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function c(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){j.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],f,g,h;if(typeof e==="string")f=e.toLowerCase();else{f=e.element?e.element.toLowerCase():a.element;g=e.attributes;h=e.styles}e=b[f]||(b[f]={});if(g){f=e.attributes=e.attributes||[];for(var i in g)f.push([i.toLowerCase(),g[i]])}if(h){var e=e.styles=e.styles||[],k;for(k in h)e.push([k.toLowerCase(),h[k]])}}}return b}
function f(a,b){var d=a._.definition,f=c(a),g=j.merge(d.attributes,(f[b.nodeName()]||f["*"]||{}).attributes),d=j.merge(d.styles,(f[b.nodeName()]||f["*"]||{}).styles),f=j.isEmptyObject(g)&&j.isEmptyObject(d),h;for(h in g)if(!((h==="class"||a._.definition.fullMatch)&&b.attr(h)!==e(h,g[h]))){f=f||!!b.hasAttr(h);b.removeAttr(h)}for(var i in d)if(!(a._.definition.fullMatch&&b.style(i)!==e(i,d[i],A))){f=f||!!b.style(i);b.style(i,"")}p(b)}function e(a,b,c){var d=m("<span>");d[c?"style":"attr"](a,b);return d[c?
"style":"attr"](a)}function a(a,b){for(var e=c(a),g=b.all(a.element),h=g.length;--h>=0;)f(a,m(g[h]));for(var i in e)if(i!==a.element){g=b.all(i);for(h=g.length-1;h>=0;h--){var j=m(g[h]);d(j,e[i])}}}function d(a,b){var c,d,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var f=e[c][0];if(d=a.attr(f)){var g=e[c][1];(g===F||g.test&&g.test(d)||typeof g==="string"&&d===g)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(c=0;c<e.length;c++){f=e[c][0];if(g=a.css(f)){var h=e[c][1];(h===F||h.test&&h.test(d)||
typeof h==="string"&&g===h)&&a.css(f,"")}}p(a)}function p(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4eRemove(A);if(b){b.nodeType===D.NodeType.ELEMENT_NODE&&D._4eMergeSiblings(b);c&&b!==c&&c.nodeType===D.NodeType.ELEMENT_NODE&&D._4eMergeSiblings(c)}}}var j=b("util"),n=b("./selection"),H=b("./range"),z=b("./base"),I=b("./element-path"),A=true,J=false,F=null,m=b("node"),D=b("dom"),v=z.RangeType,E=z.PositionType,K,O=b("ua"),P={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,
p:1,pre:1},N=z.XHTML_DTD,S={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;z.StyleType=K={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};o.prototype={constructor:o,apply:function(a){u.call(this,a,J)},remove:function(a){u.call(this,a,A)},applyToRange:function(a){return(this.applyToRange=this.type===K.STYLE_INLINE?y:this.type===K.STYLE_BLOCK?l:F).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===
K.STYLE_INLINE?t:F).call(this,a)},checkElementRemovable:function(a,b){if(!a)return J;var d,e=this._.definition,f;if(a.nodeName()===this.element){if(!b&&!a._4eHasAttributes())return A;var h=e._AC;if(!h){var h={},i=0,j=e.attributes;if(j)for(var k in j){i++;h[k]=j[k]}if(j=o.getStyleText(e)){h.style||i++;h.style=j}h._length=i;e._AC=h}e=h;if(e._length){for(d in e)if(d!=="_length"){i=a.attr(d)||"";if(d==="style")a:{h=e[d];i=g(i,J);typeof h==="string"&&(h=q(h));typeof i==="string"&&(i=q(i));j=void 0;for(j in h)if(!(j in
i&&(i[j]===h[j]||h[j]==="inherit"||i[j]==="inherit"))){h=J;break a}h=A}else h=e[d]===i;if(h){if(!b)return A}else if(b)return J}if(b)return A}else return A}d=c(this);if(d=d[a.nodeName()]||d["*"]){if(!(e=d.attributes)&&!(f=d.styles))return A;if(e)for(h=0;h<e.length;h++){d=e[h][0];if(d=a.attr(d)){i=e[h][1];if(i===F||typeof i==="string"&&d===i||i.test&&i.test(d))return A}}if(f)for(h=0;h<f.length;h++)if(d=a.css(f[h][0])){e=f[h][1];if(e===F||typeof e==="string"&&d===e||e.test&&e.test(d))return A}}return J},
checkActive:function(a){switch(this.type){case K.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,A);case K.STYLE_OBJECT:case K.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++){d=b[c];if(!(this.type===K.STYLE_INLINE&&(D.equals(d,a.block)||D.equals(d,a.blockLimit))))if((this.type!==K.STYLE_OBJECT||d.nodeName()in S)&&this.checkElementRemovable(d,A))return A}}return J}};o.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",
d="";c.length&&(c=c.replace(Q,";"));for(var e in b){var f=b[e],h=(e+":"+f).replace(Q,";");f==="inherit"?d=d+h:c=c+h}c.length&&(c=g(c));c=c+d;return a._ST=c};z.Style=o;x.exports=o});
KISSY.add("editor/dom-iterator","util,node,./walker,./range,./base,./element-path,ua,dom".split(","),function(z,b,C,x){function s(b){if(!(arguments.length<1)){this.range=b;this.forceBrBreak=w;this.enlargeBr=k;this.enforceRealBlocks=w;this._=this._||{}}}var r=b("util"),o=b("node"),u=b("./walker"),h=b("./range"),z=b("./base"),l=b("./element-path"),k=true,w=false,i=b("ua"),y=z.RangeType,t=b("dom"),q=/^[\r\n\t ]*$/;r.augment(s,{getNextParagraph:function(b){var c,f,e,a,d,p;if(!this._.lastNode){e=this.range.clone();
e.shrink(y.SHRINK_ELEMENT,k);e.enlarge(this.forceBrBreak||!this.enlargeBr?y.ENLARGE_LIST_ITEM_CONTENTS:y.ENLARGE_BLOCK_CONTENTS);f=new u(e);var j=u.bookmark(k,k);f.evaluator=j;this._.nextNode=f.next();f=new u(e);f.evaluator=j;f=f.previous();this._.lastNode=f._4eNextSourceNode(k);if(this._.lastNode&&this._.lastNode[0].nodeType===t.NodeType.TEXT_NODE&&!r.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()){j=new h(e.document);j.moveToPosition(this._.lastNode,y.POSITION_AFTER_END);
if(j.checkEndOfBlock()){j=new l(j.endContainer);this._.lastNode=(j.block||j.blockLimit)._4eNextSourceNode(k)}}if(!this._.lastNode){this._.lastNode=this._.docEndMarker=o(e.document.createTextNode(""));t.insertAfter(this._.lastNode[0],f[0])}e=null}j=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;j;){var n=w,s=j[0].nodeType!==t.NodeType.ELEMENT_NODE,z=w;if(s)j[0].nodeType===t.NodeType.TEXT_NODE&&q.test(j[0].nodeValue)&&(s=w);else{var x=j.nodeName();if(j._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){if(x==="br")s=k;else if(!e&&!j[0].childNodes.length&&x!=="hr"){c=j;a=j.equals(f);break}if(e){e.setEndAt(j,y.POSITION_BEFORE_START);if(x!=="br")this._.nextNode=j}n=k}else{if(j[0].firstChild){if(!e){e=new h(this.range.document);e.setStartAt(j,y.POSITION_BEFORE_START)}j=o(j[0].firstChild);continue}s=k}}if(s&&!e){e=new h(this.range.document);e.setStartAt(j,y.POSITION_BEFORE_START)}a=(!n||s)&&j.equals(f);if(e&&!n)for(;!j[0].nextSibling&&!a;){x=j.parent();if(x._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){n=k;a||x.equals(f);break}j=x;s=k;a=j.equals(f);z=k}s&&e.setEndAt(j,y.POSITION_AFTER_END);j=j._4eNextSourceNode(z,null,f);if((a=!j)||n&&e)break}if(!c){if(!e){this._.docEndMarker&&this._.docEndMarker._4eRemove();return this._.nextNode=null}c=new l(e.startContainer);j=c.blockLimit;n={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&n[j.nodeName()]&&e.checkStartOfBlock()&&e.checkEndOfBlock())c=j;else if(!c||this.enforceRealBlocks&&c.nodeName()==="li"){c=o(this.range.document.createElement(b||
"p"));c[0].appendChild(e.extractContents());c._4eTrim();e.insertNode(c);d=p=k}else if(c.nodeName()!=="li"){if(!e.checkStartOfBlock()||!e.checkEndOfBlock()){c=c.clone(w);c[0].appendChild(e.extractContents());c._4eTrim();p=e.splitBlock();d=!p.wasStartOfBlock;p=!p.wasEndOfBlock;e.insertNode(c)}}else if(!a)this._.nextNode=c.equals(f)?null:e.getBoundaryNodes().endNode._4eNextSourceNode(k,null,f)}if(d){e=o(c[0].previousSibling);e[0]&&e[0].nodeType===t.NodeType.ELEMENT_NODE&&(e.nodeName()==="br"?e._4eRemove():
e[0].lastChild&&t.nodeName(e[0].lastChild)==="br"&&t._4eRemove(e[0].lastChild))}if(p){e=u.bookmark(w,k);d=o(c[0].lastChild);d[0]&&d[0].nodeType===t.NodeType.ELEMENT_NODE&&d.nodeName()==="br"&&(i.ie||d.prev(e,1)||d.next(e,1))&&d.remove()}if(!this._.nextNode)this._.nextNode=a||c.equals(f)?null:c._4eNextSourceNode(k,null,f);return c}});h.prototype.createIterator=function(){return new s(this)};x.exports=s});
KISSY.add("editor/z-index-manager",["./base"],function(z,b,C,x){var s=b("./base"),z=s.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};s.baseZIndex=function(b){return(s.Config.baseZIndex||1E4)+b};x.exports=z});
